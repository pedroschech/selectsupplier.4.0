<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SelectSupplier — Sistema de Apoio à Seleção de Fornecedores</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --navy:#001a4d;--blue:#003f91;--bg:#0b1424;--card:#0f2340;--card2:#122a4d;
  --border:#1e3a5f;--text:#eaf0ff;--muted:#c5cee0;--accent:#ff6a00;
  --green:#16a34a;--yellow:#facc15;--red:#dc2626;--radius:16px;
  /* Cores Pastel SWOT */
  --pastel-yellow: #fdfd96;
  --pastel-red: #ffb3b3; 
  --pastel-green: #b0f2c2;
  --pastel-blue: #aec6cf;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,sans-serif}
body{margin:0;background:radial-gradient(1000px 600px at -10% -10%,#0d1f3a 0%,#0b1424 60%);color:var(--text)}
header{
  background:linear-gradient(135deg,var(--navy),var(--blue));
  color:#fff;display:flex;gap:12px;align-items:center;padding:18px 20px;
  box-shadow:0 8px 24px rgba(0,0,0,.35)
}
header img{height:44px}
header h1{margin:0;font-size:1.6rem}
header p{margin:0;color:#e9efff}
main{max-width:1280px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px 18px;box-shadow:0 8px 24px rgba(0,0,0,.28);margin-bottom:16px}
.btn{background:var(--accent);border:none;border-radius:999px;color:#fff;padding:8px 14px;font-weight:700;cursor:pointer; transition: opacity 0.2s}
.btn:hover{opacity:0.9}
.btn.secondary{background:#2a4a78}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn.danger{background:var(--red)}
input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0e223d;color:var(--text)}
textarea{resize:vertical; min-height:80px;}
input[type="number"]{max-width:120px}
table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.92rem}
th,td{border:1px solid var(--border);padding:6px 8px;vertical-align:top;color:var(--text)}
th{background:#16395e;text-align:left}
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.tab-btn{background:#0e223d;border:1px solid var(--border);color:var(--text);padding:7px 14px;border-radius:999px;cursor:pointer}
.tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.section{display:none}
.section.active{display:block}
.legend{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;color:var(--text)}
.box{width:14px;height:14px;border-radius:3px;display:inline-block}
.pill{display:inline-flex;gap:6px;align-items:center;background:#0e223d;border:1px solid var(--border);padding:2px 8px;border-radius:999px; font-size:0.85rem}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
@media (max-width:980px){.col-6,.col-4,.col-3,.col-2{grid-column:span 12}}
footer{text-align:center;color:var(--muted);font-size:.85rem;margin:20px 0}

/* SWOT Styles */
.swot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.swot-card { padding: 10px; border-radius: 8px; color: #000; font-weight: 500; min-height: 100px; }
.swot-f { background-color: var(--pastel-yellow); }
.swot-o { background-color: var(--pastel-red); }
.swot-w { background-color: var(--pastel-green); } /* Fraquezas (solicitado verde) */
.swot-a { background-color: var(--pastel-blue); }

/* Comments */
.comment-box { background: var(--card2); padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); }
.comment-date { font-size: 0.75rem; color: var(--muted); margin-bottom: 4px; }

/* LOGIN (dark) */
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:50}
#loginCard{background:var(--card2);color:var(--text);border-radius:14px;max-width:380px;width:100%;padding:18px 20px;border:1px solid var(--border);box-shadow:0 18px 40px rgba(0,0,0,.45)}
#loginCard h2{margin:4px 0 6px}
#loginCard input{background:#0e223d;color:var(--text);border:1px solid var(--border)}
#loginCard .btn{width:100%}

/* small helpers */
.small{font-size:.86rem}
.muted{color:var(--muted)}
.divider{height:1px;background:var(--border);margin:10px 0}
.badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);background:var(--card2);border-radius:999px}
.status-pill { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; color: #fff; }
</style>
</head>
<body>
<header>
  <img alt="logo" src="data:image/svg+xml;utf8,
    <svg xmlns='http://www.w3.org/2000/svg' width='44' height='44'>
      <rect width='44' height='44' rx='9' fill='%23003f91'/>
      <path d='M10 30 L22 10 L34 30 Z' fill='%23ff6a00'/>
    </svg>">
  <div>
    <h1>SelectSupplier</h1>
    <p>Sistema de Apoio à Seleção de Fornecedores · Indusmart</p>
  </div>
</header>

<div id="loginOverlay">
  <div id="loginCard">
    <h2>Login</h2>
    <p class="small muted">Acesso restrito</p>
    <label>Usuário</label><input id="loginUser" placeholder="">
    <label>Senha</label><input id="loginPass" type="password" placeholder="">
    <button class="btn" style="margin-top:10px" onclick="doLogin()">Entrar</button>
    <div id="loginErr" style="display:none;color:#ffd0d0;font-weight:600;margin-top:8px">Credenciais incorretas.</div>
  </div>
</div>

<main id="app" style="display:none">
  <div class="card">
    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard" onclick="switchTab(event,'dashboard')">Dashboard</button>
      <button class="tab-btn" data-tab="projetos" onclick="switchTab(event,'projetos')">Projetos</button>
      <button class="tab-btn" data-tab="projeto" onclick="switchTab(event,'projeto')">Novo Projeto</button>
      <button class="tab-btn" data-tab="orcamentistas" onclick="switchTab(event,'orcamentistas')">Orçamentistas</button>
      <button class="tab-btn" data-tab="clientes" onclick="switchTab(event,'clientes')">Clientes</button>
      <button class="tab-btn" data-tab="indices" onclick="switchTab(event,'indices')">Índices</button>
      <button class="tab-btn" data-tab="fornecedores" onclick="switchTab(event,'fornecedores')">Fornecedores</button>
      <button class="tab-btn" data-tab="cadastro" onclick="switchTab(event,'cadastro')">Manutenção Fornecedores</button>
      <button class="tab-btn" data-tab="sobre" onclick="switchTab(event,'sobre')">Sobre</button>
    </div>

    <section id="dashboard" class="section active">
        <h2>Visão Geral</h2>
        <div class="row">
            <div class="col-4">
                <div class="card" style="height:100%">
                    <h3>Status dos Projetos</h3>
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
            <div class="col-4">
                <div class="card" style="height:100%">
                    <h3>Projetos por Orçamentista</h3>
                    <canvas id="chartEstimator"></canvas>
                </div>
            </div>
            <div class="col-4">
                <div class="card" style="height:100%">
                    <h3>Projetos por Cliente (Top 5)</h3>
                    <canvas id="chartClient"></canvas>
                </div>
            </div>
        </div>
    </section>

    <section id="projeto" class="section">
      <h2>Novo Projeto de Seleção</h2>
      <div class="row">
        <div class="col-6">
          <label>Nome do projeto</label>
          <input id="projNome" placeholder="Ex.: Flange usinado + pintura">
        </div>
        <div class="col-3">
            <label>Orçamentista</label>
            <select id="projEstimator"><option value="">Selecione...</option></select>
        </div>
        <div class="col-3">
            <label>Cliente</label>
            <select id="projClient"><option value="">Selecione...</option></select>
        </div>
        <div class="col-12">
          <label>Descrição</label>
          <input id="projDesc" placeholder="Ex.: Lote piloto · lead time máximo 7 dias">
        </div>

        <div class="col-12">
            <div class="divider"></div>
            <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" id="checkSwot" onchange="toggleSwotInputs()"> <strong>Incluir Matriz SWOT/FOFA</strong>
            </label>
            <div id="swotInputs" class="row" style="display:none; margin-top:10px; background:var(--card2); padding:10px; border-radius:10px;">
                <div class="col-6"><label>Forças (F)</label><textarea id="swotF"></textarea></div>
                <div class="col-6"><label>Oportunidades (O)</label><textarea id="swotO"></textarea></div>
                <div class="col-6"><label>Fraquezas (F)</label><textarea id="swotW"></textarea></div>
                <div class="col-6"><label>Ameaças (A)</label><textarea id="swotA"></textarea></div>
            </div>
            <div class="divider"></div>
        </div>

        <div class="col-12">
          <h3>Áreas (pelo menos 1)</h3>
          <div id="areasWrap" class="row"></div>
          <button class="btn" style="margin-top:8px" onclick="addAreaRow()">+ Adicionar área</button>
        </div>

        <div class="col-12">
          <h3>Índices e Pesos</h3>
          <div class="small" style="color:var(--accent); margin-bottom:5px;">Atenção: A soma dos pesos deve ser exatamente 100.</div>
          <table>
            <thead><tr><th>Incluir</th><th>Índice</th><th>Peso (%)</th><th>Descrição</th></tr></thead>
            <tbody id="idxBody"></tbody>
            <tfoot><tr><td colspan="2" style="text-align:right">Total:</td><td id="weightSum">0</td><td></td></tr></tfoot>
          </table>
        </div>

        <div class="col-12">
          <button class="btn" onclick="calcular()">Calcular e Salvar Projeto</button>
        </div>

        <div class="col-12" id="resTable"></div>
        <div class="col-12"><canvas id="resChart" height="100"></canvas></div>
      </div>
    </section>

    <section id="projetos" class="section">
      <h2>Projetos em Andamento / Histórico</h2>
      <div id="projListContainer"></div>
    </section>

    <section id="orcamentistas" class="section">
        <h2>Gerenciar Orçamentistas</h2>
        <div class="row">
            <div class="col-8"><input id="newEstName" placeholder="Nome do Orçamentista"></div>
            <div class="col-4"><button class="btn" onclick="addEstimator()">Adicionar</button></div>
            <div class="col-12">
                <table>
                    <thead><tr><th>Nome</th><th>Ações</th></tr></thead>
                    <tbody id="estBody"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="clientes" class="section">
        <h2>Gerenciar Clientes</h2>
        <div class="row">
            <div class="col-8"><input id="newCliName" placeholder="Nome do Cliente"></div>
            <div class="col-4"><button class="btn" onclick="addClient()">Adicionar</button></div>
            <div class="col-12">
                <table>
                    <thead><tr><th>Nome</th><th>Ações</th></tr></thead>
                    <tbody id="cliBody"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="indices" class="section">
        <h2>Gerenciar Índices</h2>
        <div class="row" style="background:var(--card2); padding:10px; border-radius:10px; margin-bottom:10px;">
            <div class="col-2"><input id="newIndId" placeholder="ID (Ex: I99)"></div>
            <div class="col-4"><input id="newIndName" placeholder="Nome do Índice"></div>
            <div class="col-2">
                <select id="newIndScope">
                    <option value="area">Por Área</option>
                    <option value="global">Global</option>
                </select>
            </div>
            <div class="col-4" style="display:flex; gap:5px;">
                <input id="newIndDesc" placeholder="Descrição">
                <button class="btn" onclick="addIndex()">Add</button>
            </div>
        </div>
        <div class="col-12">
            <table>
                <thead><tr><th>ID</th><th>Nome</th><th>Escopo</th><th>Descrição</th><th>Ações</th></tr></thead>
                <tbody id="configIdxBody"></tbody>
            </table>
        </div>
    </section>

    <section id="fornecedores" class="section">
      <h2>Base de Fornecedores</h2>
      <div class="row">
        <div class="col-6">
          <label>Notas por área (opcional)</label>
          <select id="filtroAreaNotas" onchange="renderFornecedores()">
            <option value="">(selecionar área para exibir notas da área)</option>
          </select>
        </div>
        <div class="col-6" style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn ghost" onclick="renderFornecedores(true)">Limpar filtro</button>
        </div>
        <div class="col-12" id="fornList"></div>
      </div>
    </section>

    <section id="cadastro" class="section">
      <h2>Manutenção/Cadastro de Fornecedores</h2>
      <div class="row">
        <div class="col-3"><label>ID</label><input id="c_id" placeholder="Ex.: F120"></div>
        <div class="col-6"><label>Nome</label><input id="c_nome" placeholder="Ex.: MetalPrime Serviços"></div>
        <div class="col-3" style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" onclick="salvarFornecedor()">Salvar</button>
          <button class="btn secondary" onclick="limparCadastro()">Limpar</button>
        </div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-6">
          <h3>Áreas atendidas</h3>
          <div id="c_areas" class="row"></div>
        </div>
        <div class="col-6">
          <h3>Notas globais (0–10)</h3>
          <div id="c_notasGlobais"></div>
        </div>

        <div class="col-12">
          <h3>Notas por área (0–10)</h3>
          <div id="c_notasPorArea"></div>
          <div class="small muted" style="margin-top:6px">Ao marcar/desmarcar áreas atendidas, os blocos de notas por área são atualizados.</div>
        </div>
      </div>
    </section>

    <section id="sobre" class="section">
      <h2>Sobre</h2>
      <p class="small muted">Protótipo para seleção de fornecedores.</p>
    </section>
  </div>
</main>

<footer>SelectSupplier — Indusmart</footer>

<script>
/* ===================== DADOS INICIAIS ===================== */
const DEFAULT_INDICES = [
  { id:"I1",  nome:"Qualidade", scope:"area", desc:"Conformidade e não conformidades." },
  { id:"I2",  nome:"Tempo de Entrega", scope:"area", desc:"Lead time e pontualidade." },
  { id:"I3",  nome:"Custo", scope:"area", desc:"Competitividade de preço." },
  { id:"I4",  nome:"Flexibilidade", scope:"area", desc:"Reação a urgências." },
  { id:"I5",  nome:"Acuracidade Fiscal", scope:"global", desc:"Erros em notas." },
  { id:"I6",  nome:"Reclamações Técnicas", scope:"area", desc:"Histórico de problemas." },
  { id:"I7",  nome:"Normas Ambientais", scope:"global", desc:"Certificações ESG." },
  { id:"I8",  nome:"Comunicação", scope:"global", desc:"Agilidade de resposta." },
  { id:"I9",  nome:"Inovação", scope:"area", desc:"Melhorias propostas." },
  { id:"I10", nome:"Confiabilidade Financeira", scope:"global", desc:"Risco de crédito." },
  { id:"I11", nome:"Capacidade Técnica", scope:"area", desc:"Domínio de processos." },
  { id:"I12", nome:"Logística", scope:"area", desc:"Expedição e entrega." },
  { id:"I13", nome:"Compliance", scope:"global", desc:"Legal e trabalhista." },
  { id:"I14", nome:"Pós-venda", scope:"global", desc:"Suporte técnico." },
  { id:"I15", nome:"Satisfação Interna", scope:"area", desc:"Percepção usuários." }
];

const DEFAULT_ESTIMATORS = ["Bruno Ullmann", "Lucas Sitieni", "Pedro Schech", "Rafael Hirt"];
const DEFAULT_CLIENTES = [
    "Metalúrgica AçoForte", "Construções Silva", "AgroTech Brasil", "Indústrias Reunidas", 
    "TechSolutions", "AutoParts Global", "Solar Energy", "Plásticos do Sul", 
    "Mineração Vale Verde", "Papel & Celulose RS", "Alimentos Sabor", "Química Pura", 
    "Transportes Rápidos", "Engenharia Civil SA", "Móveis Design", "Hospitalar Med"
];

/* ===================== ÁREAS (FIXAS) ===================== */
const AREAS = [
  { id:"A1",  nome:"Usinagem" }, { id:"A2",  nome:"Soldagem" }, { id:"A3",  nome:"Fundição" },
  { id:"A4",  nome:"Injeção Plástica" }, { id:"A5",  nome:"Impressão 3D" }, { id:"A6",  nome:"Software / Automação" },
  { id:"A7",  nome:"Tratamento Térmico" }, { id:"A8",  nome:"Caldeiraria" }, { id:"A9",  nome:"Metrologia 3D" },
  { id:"A10", nome:"Corte a Laser / Dobra" }, { id:"A11", nome:"Pintura / Acabamento" }, { id:"A12", nome:"Extrusão" },
  { id:"A13", nome:"Rotomoldagem" }, { id:"A14", nome:"Montagem" }, { id:"A15", nome:"Moldes" }
];

/* ===================== BASE FORNECEDORES ===================== */
const BASE_FORNECEDORES = [
  { id:"F1", nome:"MecanizaPro", areas:["A1","A2","A3"], notas:{ global:{ I5:8,I7:7,I8:8,I10:7,I13:7,I14:7 }, porArea:{ A1:{ I1:8,I2:6,I3:7,I4:6,I6:8,I9:7,I11:8,I12:7,I15:8 }, A2:{ I1:6,I2:6,I3:7,I4:5,I6:7,I9:5,I11:6,I12:6,I15:6 }, A3:{ I1:5,I2:4,I3:5,I4:5,I6:6,I9:5,I11:5,I12:5,I15:5 } } }},
  { id:"F2", nome:"Usinax", areas:["A1","A2","A5","A10"], notas:{ global:{ I5:7,I7:8,I8:7,I10:6,I13:7,I14:7 }, porArea:{ A1:{ I1:7,I2:8,I3:6,I4:7,I6:8,I9:6,I11:8,I12:8,I15:7 }, A2:{ I1:7,I2:7,I3:6,I4:6,I6:7,I9:5,I11:6,I12:6,I15:6 }, A5:{ I1:8,I2:7,I3:8,I4:6,I6:7,I9:8,I11:7,I12:7,I15:7 }, A10:{ I1:7,I2:8,I3:7,I4:6,I6:7,I9:6,I11:8,I12:8,I15:7 } } }},
  { id:"F3", nome:"SmartAutomate", areas:["A6"], notas:{ global:{ I5:9,I7:9,I8:9,I10:9,I13:9,I14:9 }, porArea:{ A6:{ I1:9,I2:8,I3:8,I4:7,I6:9,I9:9,I11:8,I12:8,I15:9 } } }},
  { id:"F4", nome:"MetalPrime", areas:["A8","A7","A10"], notas:{ global:{ I5:7,I7:7,I8:7,I10:7,I13:7,I14:7 }, porArea:{ A8:{ I1:6,I2:6,I3:6,I4:6,I6:7,I9:5,I11:6,I12:6,I15:6 }, A7:{ I1:7,I2:7,I3:7,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 }, A10:{ I1:8,I2:8,I3:7,I4:6,I6:7,I9:6,I11:8,I12:8,I15:7 } } }},
  { id:"F5", nome:"GreenPlast", areas:["A4","A11"], notas:{ global:{ I5:8,I7:9,I8:7,I10:8,I13:8,I14:8 }, porArea:{ A4:{ I1:8,I2:7,I3:7,I4:7,I6:8,I9:7,I11:7,I12:7,I15:8 }, A11:{ I1:7,I2:7,I3:6,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 } } }},
  { id:"F6", nome:"LaserShape", areas:["A10","A1"], notas:{ global:{ I5:8,I7:8,I8:8,I10:7,I13:7,I14:7 }, porArea:{ A10:{ I1:8,I2:8,I3:7,I4:7,I6:8,I9:7,I11:8,I12:8,I15:7 }, A1:{  I1:7,I2:7,I3:6,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 } } }},
  { id:"F7", nome:"MetriScan", areas:["A9"], notas:{ global:{ I5:9,I7:9,I8:8,I10:8,I13:9,I14:8 }, porArea:{ A9:{ I1:9,I2:8,I3:7,I4:6,I6:8,I9:8,I11:9,I12:8,I15:8 } } }}
];

/* ===================== STORAGE KEYS ===================== */
const SK_SUP = "ss_data_suppliers";
const SK_PROJ = "ss_data_projects";
const SK_EST = "ss_data_estimators";
const SK_CLI = "ss_data_clients";
const SK_IDX = "ss_data_indices";

/* State */
let suppliers = [];
let projects = [];
let estimators = [];
let clients = [];
let indices = [];
let chartRes = null;
let dashboardCharts = {};

function loadState(){
  try{ suppliers = JSON.parse(localStorage.getItem(SK_SUP)||"null"); }catch(_){ suppliers=null; }
  if(!Array.isArray(suppliers)) suppliers = structuredClone(BASE_FORNECEDORES);

  try{ projects = JSON.parse(localStorage.getItem(SK_PROJ)||"null"); }catch(_){ projects=null; }
  if(!Array.isArray(projects)) projects = [];

  try{ estimators = JSON.parse(localStorage.getItem(SK_EST)||"null"); }catch(_){ estimators=null; }
  if(!Array.isArray(estimators)) estimators = [...DEFAULT_ESTIMATORS];

  try{ clients = JSON.parse(localStorage.getItem(SK_CLI)||"null"); }catch(_){ clients=null; }
  if(!Array.isArray(clients)) clients = [...DEFAULT_CLIENTES];

  try{ indices = JSON.parse(localStorage.getItem(SK_IDX)||"null"); }catch(_){ indices=null; }
  if(!Array.isArray(indices)) indices = [...DEFAULT_INDICES];
}

function saveData(){
  localStorage.setItem(SK_SUP, JSON.stringify(suppliers));
  localStorage.setItem(SK_PROJ, JSON.stringify(projects));
  localStorage.setItem(SK_EST, JSON.stringify(estimators));
  localStorage.setItem(SK_CLI, JSON.stringify(clients));
  localStorage.setItem(SK_IDX, JSON.stringify(indices));
}

/* ===================== LOGIN ===================== */
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(u==="adm" && p==="123"){
    document.getElementById('loginOverlay').style.display="none";
    document.getElementById('app').style.display="block";
    initUI();
  }else{
    document.getElementById('loginErr').style.display="block";
  }
}

/* ===================== UI & TABS ===================== */
function switchTab(ev,id){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  if(ev) ev.target.classList.add("active");
  
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  if(id==="dashboard") updateDashboard();
  if(id==="fornecedores") renderFornecedores();
  if(id==="cadastro") renderCadastro();
  if(id==="projetos") renderProjectList();
  if(id==="orcamentistas") renderEstimators();
  if(id==="clientes") renderClients();
  if(id==="indices") renderIndicesConfig();
  if(id==="projeto") populateProjectDropdowns();
}

function toggleSwotInputs(){
    const chk = document.getElementById('checkSwot').checked;
    document.getElementById('swotInputs').style.display = chk ? 'grid' : 'none';
}

/* ===================== ORÇAMENTISTAS & CLIENTES CRUD ===================== */
function populateProjectDropdowns(){
    const se = document.getElementById('projEstimator');
    se.innerHTML = `<option value="">Selecione...</option>` + estimators.map(e=>`<option>${e}</option>`).join('');
    
    const sc = document.getElementById('projClient');
    sc.innerHTML = `<option value="">Selecione...</option>` + clients.map(c=>`<option>${c}</option>`).join('');
}

function renderEstimators(){
    const tb = document.getElementById('estBody');
    tb.innerHTML = estimators.map((e,i)=>`<tr><td>${e}</td><td>
        <button class="btn secondary small" onclick="editEst(${i})">Edit</button> 
        <button class="btn danger small" onclick="delEst(${i})">X</button>
    </td></tr>`).join('');
}
function addEstimator(){
    const v = document.getElementById('newEstName').value.trim();
    if(v) { estimators.push(v); saveData(); renderEstimators(); document.getElementById('newEstName').value=""; }
}
function editEst(i){
    const v = prompt("Novo nome:", estimators[i]);
    if(v){ estimators[i]=v; saveData(); renderEstimators(); }
}
function delEst(i){
    if(confirm("Excluir?")) { estimators.splice(i,1); saveData(); renderEstimators(); }
}

function renderClients(){
    const tb = document.getElementById('cliBody');
    tb.innerHTML = clients.map((c,i)=>`<tr><td>${c}</td><td>
        <button class="btn secondary small" onclick="editCli(${i})">Edit</button> 
        <button class="btn danger small" onclick="delCli(${i})">X</button>
    </td></tr>`).join('');
}
function addClient(){
    const v = document.getElementById('newCliName').value.trim();
    if(v) { clients.push(v); saveData(); renderClients(); document.getElementById('newCliName').value=""; }
}
function editCli(i){
    const v = prompt("Novo nome:", clients[i]);
    if(v){ clients[i]=v; saveData(); renderClients(); }
}
function delCli(i){
    if(confirm("Excluir?")) { clients.splice(i,1); saveData(); renderClients(); }
}

/* ===================== INDICES CRUD ===================== */
function renderIndicesConfig(){
    const tb = document.getElementById('configIdxBody');
    tb.innerHTML = indices.map((ind, i) => `<tr>
        <td>${ind.id}</td><td>${ind.nome}</td><td>${ind.scope}</td><td>${ind.desc}</td>
        <td><button class="btn danger small" onclick="delIndex(${i})">X</button></td>
    </tr>`).join('');
}
function addIndex(){
    const id = document.getElementById('newIndId').value.trim();
    const nome = document.getElementById('newIndName').value.trim();
    const scope = document.getElementById('newIndScope').value;
    const desc = document.getElementById('newIndDesc').value.trim();
    if(!id || !nome){ alert("Preencha ID e Nome"); return; }
    if(indices.some(x=>x.id===id)){ alert("ID já existe"); return; }
    indices.push({id, nome, scope, desc});
    saveData(); renderIndicesConfig();
    document.getElementById('newIndId').value=""; document.getElementById('newIndName').value="";
}
function delIndex(i){
    if(confirm("Excluir índice? Isso pode afetar cálculos antigos.")) { indices.splice(i,1); saveData(); renderIndicesConfig(); }
}

/* ===================== PROJETO / CÁLCULO ===================== */
function addAreaRow(){
  const wrap = document.getElementById('areasWrap');
  const idx = wrap.querySelectorAll('.card').length; 
  const row = document.createElement('div');
  row.className="col-12";
  row.innerHTML = `
    <div class="card" style="padding:10px">
      <div class="row">
        <div class="col-6">
          <label>Área</label>
          <select class="area-select">${AREAS.map(a=>`<option value="${a.id}">${a.nome}</option>`).join("")}</select>
        </div>
        <div class="col-4">
          <label>Peso da área (%)</label>
          <input class="area-weight" type="number" min="0" max="100" value="10">
        </div>
        <div class="col-2" style="display:flex;align-items:flex-end;">
          <button class="btn secondary remove-area" ${idx===0?'disabled':''}>Remover</button>
        </div>
      </div>
    </div>`;
  wrap.appendChild(row);
  row.querySelector('.remove-area').onclick = () => { if(idx>0) row.remove(); };
}

function renderIndicesForCalculation(){
  const tb = document.getElementById('idxBody');
  tb.innerHTML = "";
  indices.forEach(ind=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="idx-inc" data-id="${ind.id}" onchange="updateWeightSum()"></td>
      <td>${ind.id} — ${ind.nome}</td>
      <td><input type="number" class="idx-weight" data-id="${ind.id}" min="0" max="100" value="0" onchange="updateWeightSum()"></td>
      <td class="small muted">${ind.desc||""}</td>
    `;
    tb.appendChild(tr);
  });
}

function updateWeightSum(){
    let sum = 0;
    document.querySelectorAll('.idx-inc:checked').forEach(chk => {
        const id = chk.dataset.id;
        const val = parseFloat(document.querySelector(`.idx-weight[data-id='${id}']`).value) || 0;
        sum += val;
    });
    const el = document.getElementById('weightSum');
    el.textContent = sum.toFixed(1);
    el.style.color = sum === 100 ? 'var(--green)' : 'var(--red)';
}

function clamp(n,min,max){ n=Number(n); if(isNaN(n)) return 0; return Math.min(Math.max(n,min),max); }
function colorByScore(v){ if(v>=7) return getVar('--green'); if(v>=4) return getVar('--yellow'); return getVar('--red'); }
function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

function calcular(){
  const name = (document.getElementById('projNome').value||"").trim();
  const estimator = document.getElementById('projEstimator').value;
  const client = document.getElementById('projClient').value;
  const desc = (document.getElementById('projDesc').value||"").trim();

  // Validações
  if(!name || !estimator || !client) { alert("Preencha Nome, Orçamentista e Cliente."); return; }

  // Áreas
  const areaRows = [...document.querySelectorAll('#areasWrap .card')].map(card=>{
    return { 
        id: card.querySelector('.area-select').value, 
        peso: clamp(card.querySelector('.area-weight').value,0,100) 
    };
  });
  if(!areaRows.length){ alert("Adicione ao menos 1 área."); return; }
  // Normaliza pesos das áreas (soma das áreas pode ser qualquer coisa, normalizamos pra 1 internamente)
  const totalAreaW = areaRows.reduce((a,b)=>a+b.peso,0);
  const areasW = areaRows.map(a=>({...a, w: totalAreaW>0 ? a.peso/totalAreaW : 0}));

  // Índices
  let sumW = 0;
  const idxRows = indices.map(ind=>{
    const inc = document.querySelector(`.idx-inc[data-id='${ind.id}']`).checked;
    const peso = clamp(document.querySelector(`.idx-weight[data-id='${ind.id}']`).value,0,100);
    if(inc) sumW += peso;
    return { id:ind.id, nome:ind.nome, scope:ind.scope, inc, peso, desc:ind.desc };
  }).filter(r=>r.inc);

  if(Math.abs(sumW - 100) > 0.1) {
      alert(`A soma dos pesos dos índices deve ser exatamente 100. Atual: ${sumW}`);
      return;
  }
  // Normaliza para 0-1
  const idxW = idxRows.map(i => ({...i, w: i.peso/100}));

  // SWOT
  let swotData = null;
  if(document.getElementById('checkSwot').checked){
      swotData = {
          f: document.getElementById('swotF').value,
          o: document.getElementById('swotO').value,
          w: document.getElementById('swotW').value,
          a: document.getElementById('swotA').value
      };
  }

  // CÁLCULO
  const areasIds = areasW.map(a=>a.id);
  // Considera apenas quem atende todas as áreas
  const considerados = suppliers.filter(f => areasIds.every(a => f.areas.includes(a)));

  const resultados = considerados.map(f=>{
    const areaScores = areasW.map(a=>{
      let s=0;
      idxW.forEach(ix=>{
        let nota=0;
        if(ix.scope==="area") nota = f.notas?.porArea?.[a.id]?.[ix.id] ?? 0;
        else nota = f.notas?.global?.[ix.id] ?? 0;
        s += nota * ix.w;
      });
      return { area:a.id, w:a.w, score:s };
    });
    const final = areaScores.reduce((acc,it)=>acc + it.score*it.w, 0);
    return { f, final, areaScores };
  }).sort((a,b)=>b.final - a.final);

  // Render resultados na tela de cálculo
  renderResultados(resultados, areasW);
  renderGrafico(resultados);

  // Salvar Projeto
  const newProject = {
    id: Date.now().toString(),
    nome: name,
    desc,
    estimator,
    client,
    data: new Date().toISOString(),
    status: "A iniciar",
    areas: areasW,
    indices: idxW, // salvamos o snapshot dos indices usados
    swot: swotData,
    resultados: resultados.map(r=>({
        id: r.f.id,
        nome: r.f.nome,
        final: r.final,
        areaScores: r.areaScores
    })),
    comments: []
  };
  projects.unshift(newProject);
  saveData();
  alert("Projeto calculado e salvo na aba 'Projetos'.");
}

function renderResultados(lista, areasW){
  const box = document.getElementById('resTable');
  if(!lista.length){ box.innerHTML = "<p class='muted'>Nenhum fornecedor atende a todas as áreas selecionadas.</p>"; return; }

  let head = `<tr><th>Rank</th><th>Fornecedor</th><th>Score Final</th>`;
  areasW.forEach(a=>{
    const nome = AREAS.find(x=>x.id===a.id)?.nome || a.id;
    head += `<th>${nome}</th>`;
  });
  head += `</tr>`;

  let body = "";
  lista.forEach((r,i)=>{
    body += `<tr>
      <td>#${i+1}</td>
      <td>${r.f.nome}</td>
      <td><span class="pill" style="border-color:${colorByScore(r.final)}">${r.final.toFixed(2)}</span></td>
      ${r.areaScores.map(sa=>`<td><span class="pill" style="border-color:${colorByScore(sa.score)}">${sa.score.toFixed(2)}</span></td>`).join("")}
    </tr>`;
  });
  box.innerHTML = `<h3>Resultado Preliminar</h3><table><thead>${head}</thead><tbody>${body}</tbody></table>`;
}

function renderGrafico(lista){
  const ctx = document.getElementById('resChart').getContext('2d');
  if(chartRes){ chartRes.destroy(); }
  const labels = lista.map(r=>r.f.nome);
  const data = lista.map(r=>+r.final.toFixed(2));
  const colors = data.map(v=>colorByScore(v));
  chartRes = new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ label:'Score', data, backgroundColor:colors, borderColor:colors }]},
    options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:10 } } }
  });
}

/* ===================== LISTAGEM DE PROJETOS E GESTÃO ===================== */
function renderProjectList(){
    const container = document.getElementById('projListContainer');
    if(!projects.length) { container.innerHTML="<p class='muted'>Sem projetos.</p>"; return; }

    container.innerHTML = projects.map((p, ix) => {
        // Cores de status
        let stColor = '#888';
        if(p.status === 'Em andamento') stColor = 'var(--yellow)';
        if(p.status === 'Concluído') stColor = 'var(--green)';

        // HTML do SWOT se existir
        let swotHTML = '';
        if(p.swot) {
            swotHTML = `
            <div class="swot-grid small">
                <div class="swot-card swot-f"><strong>Forças:</strong><br>${p.swot.f||'-'}</div>
                <div class="swot-card swot-o"><strong>Oportunidades:</strong><br>${p.swot.o||'-'}</div>
                <div class="swot-card swot-w"><strong>Fraquezas:</strong><br>${p.swot.w||'-'}</div>
                <div class="swot-card swot-a"><strong>Ameaças:</strong><br>${p.swot.a||'-'}</div>
            </div>`;
        }

        // Comentários
        const commentsHTML = p.comments.map(c => `
            <div class="comment-box">
                <div class="comment-date">${new Date(c.date).toLocaleString()}</div>
                <div>${c.text}</div>
            </div>
        `).join('');

        return `
        <div class="card">
            <div class="row">
                <div class="col-8">
                    <h3>${p.nome}</h3>
                    <p class="small muted">${p.desc} - ${new Date(p.data).toLocaleDateString()}</p>
                    <div class="small">
                        <strong>Orçamentista:</strong> ${p.estimator} | <strong>Cliente:</strong> ${p.client}
                    </div>
                </div>
                <div class="col-4" style="text-align:right">
                    <span class="status-pill" style="background:${stColor}">${p.status}</span>
                    <br><br>
                    <button class="btn small" onclick="exportPDF(${ix})">Exportar PDF</button>
                    <button class="btn danger small" onclick="deleteProj(${ix})">Excluir</button>
                </div>
                
                <div class="col-12"><div class="divider"></div></div>

                <div class="col-6">
                    <h4>Alterar Status</h4>
                    <select onchange="updateStatus(${ix}, this.value)">
                        <option value="A iniciar" ${p.status==='A iniciar'?'selected':''}>A iniciar</option>
                        <option value="Em andamento" ${p.status==='Em andamento'?'selected':''}>Em andamento</option>
                        <option value="Concluído" ${p.status==='Concluído'?'selected':''}>Concluído</option>
                    </select>
                    
                    <h4 style="margin-top:15px">Comentários</h4>
                    <div style="max-height:200px; overflow-y:auto; margin-bottom:10px">${commentsHTML}</div>
                    <div style="display:flex; gap:5px">
                        <input id="commInput_${ix}" placeholder="Novo comentário...">
                        <button class="btn secondary" onclick="addComment(${ix})">Add</button>
                    </div>
                </div>

                <div class="col-6">
                    <h4>Resumo SWOT</h4>
                    ${p.swot ? swotHTML : '<p class="small muted">Não incluída.</p>'}
                </div>
            </div>
        </div>
        `;
    }).join('');
}

function updateStatus(ix, val){
    projects[ix].status = val;
    saveData();
    renderProjectList();
}
function addComment(ix){
    const inp = document.getElementById(`commInput_${ix}`);
    const txt = inp.value.trim();
    if(txt){
        projects[ix].comments.push({ date: new Date().toISOString(), text: txt });
        saveData();
        renderProjectList();
    }
}
function deleteProj(ix){
    if(confirm("Excluir projeto?")) { projects.splice(ix,1); saveData(); renderProjectList(); }
}

/* ===================== DASHBOARD ===================== */
function updateDashboard(){
    // Counts
    const statusCounts = { 'A iniciar':0, 'Em andamento':0, 'Concluído':0 };
    const estCounts = {};
    const cliCounts = {};

    projects.forEach(p => {
        statusCounts[p.status] = (statusCounts[p.status]||0)+1;
        estCounts[p.estimator] = (estCounts[p.estimator]||0)+1;
        cliCounts[p.client] = (cliCounts[p.client]||0)+1;
    });

    // Chart Status
    renderDashChart('chartStatus', 'doughnut', Object.keys(statusCounts), Object.values(statusCounts), 
        [getVar('--blue'), getVar('--yellow'), getVar('--green')]);

    // Chart Estimator
    renderDashChart('chartEstimator', 'bar', Object.keys(estCounts), Object.values(estCounts), getVar('--accent'));

    // Chart Client (Top 5)
    const sortedClients = Object.entries(cliCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
    renderDashChart('chartClient', 'bar', sortedClients.map(x=>x[0]), sortedClients.map(x=>x[1]), '#8844ff');
}

function renderDashChart(id, type, labels, data, colors){
    const ctx = document.getElementById(id).getContext('2d');
    if(dashboardCharts[id]) dashboardCharts[id].destroy();
    dashboardCharts[id] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: { responsive: true, plugins:{ legend:{display: type==='doughnut'} } }
    });
}

/* ===================== PDF EXPORT ===================== */
async function exportPDF(ix){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const p = projects[ix];

    // Header
    doc.setFillColor(0, 26, 77); // Navy
    doc.rect(0, 0, 210, 20, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.text("Resumo do Projeto - SelectSupplier", 10, 13);
    
    // Info Geral
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    let y = 30;
    doc.text(`Projeto: ${p.nome}`, 10, y); y+=7;
    doc.setFontSize(10);
    doc.text(`Descrição: ${p.desc}`, 10, y); y+=6;
    doc.text(`Data: ${new Date(p.data).toLocaleDateString()}`, 10, y); y+=6;
    doc.text(`Orçamentista: ${p.estimator}`, 10, y); y+=6;
    doc.text(`Cliente: ${p.client}`, 10, y); y+=6;
    doc.text(`Status: ${p.status}`, 10, y); y+=10;

    // Índices usados
    doc.setFontSize(11);
    doc.setTextColor(0, 63, 145);
    doc.text("Índices e Pesos", 10, y); y+=6;
    const indicesData = p.indices.map(i => [i.nome, `${i.peso}%`]);
    doc.autoTable({
        startY: y,
        head: [['Índice', 'Peso']],
        body: indicesData,
        theme: 'striped',
        styles: { fontSize: 8 },
        headStyles: { fillColor: [0, 63, 145] },
        margin: { left: 10, right: 120 } // tabela estreita
    });
    
    // SWOT (Se houver)
    if(p.swot) {
        let swotY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(11);
        doc.setTextColor(0, 63, 145);
        doc.text("Matriz SWOT", 10, swotY); swotY += 5;
        
        doc.setFontSize(9);
        doc.setTextColor(0,0,0);
        // Desenhando quadros simples
        const h = 25; const w = 90;
        
        // Forças (Amarelo)
        doc.setFillColor(253, 253, 150); doc.rect(10, swotY, w, h, 'F');
        doc.text(`FORÇAS:\n${p.swot.f}`, 12, swotY+5);
        
        // Oportunidades (Vermelho)
        doc.setFillColor(255, 179, 179); doc.rect(105, swotY, w, h, 'F');
        doc.text(`OPORTUNIDADES:\n${p.swot.o}`, 107, swotY+5);

        swotY += h + 2;

        // Fraquezas (Verde)
        doc.setFillColor(176, 242, 194); doc.rect(10, swotY, w, h, 'F');
        doc.text(`FRAQUEZAS:\n${p.swot.w}`, 12, swotY+5);

        // Ameaças (Azul)
        doc.setFillColor(174, 198, 207); doc.rect(105, swotY, w, h, 'F');
        doc.text(`AMEAÇAS:\n${p.swot.a}`, 107, swotY+5);
        
        y = swotY + h + 10;
    } else {
        y = doc.lastAutoTable.finalY + 10;
    }

    // Tabela Fornecedores (Completa)
    if(y > 250) { doc.addPage(); y = 20; }
    doc.setFontSize(11);
    doc.setTextColor(0, 63, 145);
    doc.text("Classificação dos Fornecedores", 10, y);
    
    const supData = p.resultados.map((r, i) => [
        `#${i+1}`, 
        r.nome, 
        r.final.toFixed(2),
        r.areaScores.map(a => a.score.toFixed(2)).join(' | ')
    ]);

    doc.autoTable({
        startY: y + 5,
        head: [['Rank', 'Fornecedor', 'Score Final', 'Notas por Área']],
        body: supData,
        theme: 'grid',
        headStyles: { fillColor: [255, 106, 0] }, // Laranja accent
        styles: { fontSize: 8 }
    });

    // Observações
    if(p.comments.length > 0){
        let finalY = doc.lastAutoTable.finalY + 10;
        if(finalY > 270) { doc.addPage(); finalY = 20; }
        doc.setTextColor(0, 63, 145);
        doc.text("Histórico / Comentários", 10, finalY);
        p.comments.forEach(c => {
            finalY += 6;
            doc.setFontSize(8);
            doc.setTextColor(80);
            doc.text(`${new Date(c.date).toLocaleDateString()}: ${c.text}`, 10, finalY);
        });
    }

    doc.save(`Projeto_${p.nome.replace(/\s+/g,'_')}.pdf`);
}

/* ===================== FORNECEDORES & MANUTENÇÃO (Do código antigo, adaptado) ===================== */
function renderFornecedores(clear){
  const sel = document.getElementById('filtroAreaNotas');
  if(sel.options.length<=1){
    AREAS.forEach(a=>{ const o=document.createElement('option');o.value=a.id;o.textContent=a.nome;sel.appendChild(o); });
  }
  if(clear) sel.value="";
  const areaNotas = sel.value || "";
  
  const div = document.getElementById('fornList');
  let head = `<tr><th>ID</th><th>Fornecedor</th><th>Áreas</th><th>Notas Globais</th>`;
  if(areaNotas) head += `<th>Notas — ${AREAS.find(a=>a.id===areaNotas)?.nome}</th>`;
  head += `<th>Ações</th></tr>`;

  let body = "";
  suppliers.forEach(f=>{
    const areas = f.areas.map(a=>AREAS.find(x=>x.id===a)?.nome||a).join(", ");
    // Mapeia notas usando a lista dinâmica de índices
    const globais = Object.entries(f.notas?.global||{}).map(([k,v])=>{
       const n = indices.find(i=>i.id===k)?.nome||k; return `${n}: ${v}`;
    }).join("; ");

    let colArea = "";
    if(areaNotas){
      const notasA = f.notas?.porArea?.[areaNotas]||{};
      colArea = Object.entries(notasA).map(([k,v])=>{
        const n = indices.find(i=>i.id===k)?.nome||k; return `${n}: ${v}`;
      }).join("; ");
    }

    body += `<tr>
      <td>${f.id}</td><td>${f.nome}</td><td><div class="small">${areas}</div></td>
      <td><div class="small">${globais||"—"}</div></td>
      ${areaNotas?`<td><div class="small">${colArea||"—"}</div></td>`:""}
      <td>
        <button class="btn secondary small" onclick="editarFornecedor('${f.id}')">Edit</button>
        <button class="btn danger small" onclick="excluirFornecedor('${f.id}')">Ex</button>
      </td>
    </tr>`;
  });
  div.innerHTML = `<table><thead>${head}</thead><tbody>${body}</tbody></table>`;
}

let editingId = null;
function renderCadastro(){
  const wrapAreas = document.getElementById('c_areas');
  wrapAreas.innerHTML = AREAS.map(a=>`
    <label class="col-3 small"><input type="checkbox" value="${a.id}" onchange="renderNotasPorArea()"> ${a.nome}</label>
  `).join("");
  
  // Renderiza Inputs Globais Baseado nos Índices Dinâmicos
  const wrapGlob = document.getElementById('c_notasGlobais');
  wrapGlob.innerHTML = indices.filter(i=>i.scope==="global").map(i=>`
    <label class="small">${i.id} — ${i.nome} <input type="number" min="0" max="10" step="0.1" data-id="${i.id}"></label>
  `).join("");
  renderNotasPorArea();
}

function renderNotasPorArea(){
  const wrap = document.getElementById('c_notasPorArea');
  const marcadas = [...document.querySelectorAll('#c_areas input:checked')].map(i=>i.value);
  const idxArea = indices.filter(i=>i.scope==="area");
  if(!marcadas.length){ wrap.innerHTML = `<p class="muted">Marque ao menos uma área.</p>`; return; }
  
  wrap.innerHTML = marcadas.map(a=>{
    const nome = AREAS.find(x=>x.id===a)?.nome||a;
    const ins = idxArea.map(i=>`
      <label class="small">${i.id} — ${i.nome} <input type="number" min="0" max="10" step="0.1" data-id="${i.id}"></label>
    `).join("");
    return `<div class="card" style="background:var(--card2)"><div class="badge">${nome}</div><div>${ins}</div></div>`;
  }).join("");
}

function limparCadastro(){
  editingId = null;
  document.getElementById('c_id').value = "";
  document.getElementById('c_nome').value = "";
  renderCadastro();
}

function salvarFornecedor(){
  const id = (document.getElementById('c_id').value||"").trim();
  const nome = (document.getElementById('c_nome').value||"").trim();
  if(!id || !nome){ alert("Preencha ID e Nome."); return; }
  const areas = [...document.querySelectorAll('#c_areas input:checked')].map(i=>i.value);
  if(!areas.length){ alert("Selecione áreas."); return; }

  const globais = {};
  document.querySelectorAll('#c_notasGlobais input').forEach(inp=>{
    const v = inp.value.trim(); if(v!=="") globais[inp.dataset.id] = clamp(v,0,10);
  });
  const porArea = {};
  document.querySelectorAll('#c_notasPorArea .card').forEach(card=>{
    const areaNome = card.querySelector('.badge').textContent;
    const areaId = AREAS.find(a=>a.nome===areaNome)?.id;
    if(!areaId) return;
    porArea[areaId] = {};
    card.querySelectorAll('input').forEach(i=>{
      const v = i.value.trim(); if(v!=="") porArea[areaId][i.dataset.id] = clamp(v,0,10);
    });
  });

  const obj = { id, nome, areas, notas:{ global:globais, porArea } };
  if(editingId){
    const ix = suppliers.findIndex(f=>f.id===editingId);
    if(ix>=0) suppliers[ix] = obj;
    editingId = null;
  }else{
    if(suppliers.some(f=>f.id===id)){ alert("ID duplicado."); return; }
    suppliers.push(obj);
  }
  saveData();
  alert("Salvo!");
  renderFornecedores();
}

function editarFornecedor(id){
  const f = suppliers.find(x=>x.id===id);
  if(!f) return;
  editingId = id;
  switchTab(null, 'cadastro');
  document.getElementById('c_id').value = f.id;
  document.getElementById('c_nome').value = f.nome;
  renderCadastro(); // reseta checkboxes
  f.areas.forEach(a=>{
    const el = [...document.querySelectorAll('#c_areas input')].find(i=>i.value===a);
    if(el) el.checked = true;
  });
  renderNotasPorArea();
  // Fill values
  Object.entries(f.notas?.global||{}).forEach(([k,v])=>{
    const el = document.querySelector(`#c_notasGlobais input[data-id='${k}']`);
    if(el) el.value = v;
  });
  Object.entries(f.notas?.porArea||{}).forEach(([aid,map])=>{
    const areaCard = [...document.querySelectorAll('#c_notasPorArea .card')].find(c=>c.querySelector('.badge').textContent === AREAS.find(x=>x.id===aid)?.nome);
    if(areaCard){
        Object.entries(map).forEach(([k,v])=>{
            const el = areaCard.querySelector(`input[data-id='${k}']`);
            if(el) el.value=v;
        });
    }
  });
}
function excluirFornecedor(id){
    if(confirm("Excluir?")) { suppliers = suppliers.filter(f=>f.id!==id); saveData(); renderFornecedores(); }
}

/* ===================== INIT ===================== */
function initUI(){
  loadState();
  renderIndicesForCalculation();
  addAreaRow();
  updateDashboard();
  switchTab(null, 'dashboard');
}

loadState();
</script>
</body>
</html>
