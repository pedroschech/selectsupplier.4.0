<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SelectSupplier — Sistema de Apoio à Seleção de Fornecedores</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --navy:#001a4d;--blue:#003f91;--bg:#0b1424;--card:#0f2340;--card2:#122a4d;
  --border:#1e3a5f;--text:#eaf0ff;--muted:#c5cee0;--accent:#ff6a00;
  --green:#16a34a;--yellow:#facc15;--red:#dc2626;--radius:16px;
  
  /* Cores Pasteis SWOT */
  --pastel-yellow: #fff9c4;
  --pastel-red: #ffcdd2;
  --pastel-green: #c8e6c9;
  --pastel-blue: #bbdefb;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,sans-serif}
body{margin:0;background:radial-gradient(1000px 600px at -10% -10%,#0d1f3a 0%,#0b1424 60%);color:var(--text)}
header{
  background:linear-gradient(135deg,var(--navy),var(--blue));
  color:#fff;display:flex;gap:12px;align-items:center;padding:18px 20px;
  box-shadow:0 8px 24px rgba(0,0,0,.35)
}
header img{height:44px}
header h1{margin:0;font-size:1.6rem}
header p{margin:0;color:#e9efff}
main{max-width:1280px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px 18px;box-shadow:0 8px 24px rgba(0,0,0,.28);margin-bottom:16px}
.btn{background:var(--accent);border:none;border-radius:999px;color:#fff;padding:8px 14px;font-weight:700;cursor:pointer}
.btn.secondary{background:#2a4a78}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn.danger{background:var(--red)}

/* INPUTS GERAIS */
input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0e223d;color:var(--text)}
input[type="number"]{max-width:120px}
/* CORREÇÃO VISUAL: Checkboxes */
input[type="checkbox"] { width: auto; margin-right: 8px; cursor: pointer; transform: scale(1.2); }

textarea{resize:vertical; min-height:80px;}
table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.92rem}
th,td{border:1px solid var(--border);padding:6px 8px;vertical-align:top;color:var(--text)}
th{background:#16395e;text-align:left}
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.tab-btn{background:#0e223d;border:1px solid var(--border);color:var(--text);padding:7px 14px;border-radius:999px;cursor:pointer}
.tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.section{display:none}
.section.active{display:block}
.legend{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;color:var(--text)}
.box{width:14px;height:14px;border-radius:3px;display:inline-block}
.pill{display:inline-flex;gap:6px;align-items:center;background:#0e223d;border:1px solid var(--border);padding:2px 8px;border-radius:999px}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
@media (max-width:980px){.col-6,.col-4,.col-3,.col-2{grid-column:span 12}}
footer{text-align:center;color:var(--muted);font-size:.85rem;margin:20px 0}

/* Checkboxes visual fix */
.checkbox-label {
    display: flex; 
    align-items: center; 
    cursor: pointer; 
    padding: 5px 0;
}

/* SWOT Styles */
.swot-container{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
.swot-card{padding:10px; border-radius:8px; color:#000; min-height:120px;}
.swot-card h4{margin:0 0 5px 0; font-weight:800; text-transform:uppercase; font-size:0.9rem; color:#000;}
.swot-card textarea{background:rgba(255,255,255,0.5); color:#000; border:1px solid rgba(0,0,0,0.1); width:100%; height:80px;}
.bg-yellow{background:var(--pastel-yellow);}
.bg-red{background:var(--pastel-red);}
.bg-green{background:var(--pastel-green);}
.bg-blue{background:var(--pastel-blue);}

/* ISHIKAWA (FISHBONE) STYLES */
.fishbone-wrapper {
    margin-top: 15px;
    padding: 10px;
    background: #0d1f3a;
    border: 1px dashed var(--border);
    border-radius: 12px;
    overflow-x: auto;
}
.fish-container {
    display: flex;
    align-items: center;
    min-width: 800px; /* Garante que não quebre em telas pequenas */
    position: relative;
    padding: 20px 0;
}
.fish-ribs {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
}
.fish-spine {
    height: 4px;
    background: var(--muted);
    width: 100%;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 0;
}
.fish-row {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    position: relative;
    z-index: 1;
}
.fish-bone-box {
    width: 30%;
    position: relative;
}
/* Linhas diagonais (costelas) */
.fish-row.top .fish-bone-box::after {
    content: ''; position: absolute; bottom: -20px; left: 50%; width: 2px; height: 30px;
    background: var(--muted); transform: rotate(-30deg); transform-origin: bottom center; z-index: -1;
}
.fish-row.bottom .fish-bone-box::before {
    content: ''; position: absolute; top: -20px; left: 50%; width: 2px; height: 30px;
    background: var(--muted); transform: rotate(30deg); transform-origin: top center; z-index: -1;
}

.fish-input-card {
    background: var(--card2);
    border: 1px solid var(--blue);
    padding: 8px;
    border-radius: 8px;
}
.fish-label {
    font-size: 0.75rem;
    color: var(--accent);
    text-transform: uppercase;
    font-weight: bold;
    margin-bottom: 4px;
    display: block;
}
.fish-head {
    width: 180px;
    margin-left: 10px;
    position: relative;
    display: flex;
    align-items: center;
}
.fish-head-shape {
    background: var(--accent);
    color: #fff;
    padding: 15px;
    border-radius: 0 50px 50px 0; /* Formato de ponta */
    width: 100%;
    text-align: center;
}
.fish-head-shape label { font-size: 0.8rem; opacity: 0.9; display:block; margin-bottom:4px; }
.fish-head-shape input { background: rgba(255,255,255,0.2); color:#fff; border:none; text-align:center; }
.fish-head-shape input::placeholder { color: rgba(255,255,255,0.6); }

/* LOGIN (dark) */
#loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:50}
#loginCard{background:var(--card2);color:var(--text);border-radius:14px;max-width:380px;width:100%;padding:18px 20px;border:1px solid var(--border);box-shadow:0 18px 40px rgba(0,0,0,.45)}
#loginCard h2{margin:4px 0 6px}
#loginCard input{background:#0e223d;color:var(--text);border:1px solid var(--border)}
#loginCard .btn{width:100%}

/* Dashboard Stats */
.stat-card{background:var(--card2); padding:15px; border-radius:12px; text-align:center; border:1px solid var(--border);}
.stat-val{font-size:2rem; font-weight:bold; color:var(--accent);}
.stat-label{font-size:0.9rem; color:var(--muted);}

/* Filters in Dashboard */
.filter-bar{background:var(--card); padding:10px; border-radius:12px; display:flex; gap:10px; align-items:flex-end; border:1px solid var(--border); margin-bottom:15px;}
.filter-group{flex:1;}
.filter-group label{display:block; font-size:0.8rem; color:var(--muted); margin-bottom:4px;}

/* small helpers */
.small{font-size:.86rem}
.muted{color:var(--muted)}
.divider{height:1px;background:var(--border);margin:10px 0}
.badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);background:var(--card2);border-radius:999px}
</style>
</head>
<body>
<header>
  <img alt="logo" src="data:image/svg+xml;utf8,
    <svg xmlns='http://www.w3.org/2000/svg' width='44' height='44'>
      <rect width='44' height='44' rx='9' fill='%23003f91'/>
      <path d='M10 30 L22 10 L34 30 Z' fill='%23ff6a00'/>
    </svg>">
  <div>
    <h1>SelectSupplier</h1>
    <p>Sistema de Apoio à Seleção de Fornecedores</p>
  </div>
</header>

<div id="loginOverlay">
  <div id="loginCard">
    <h2>Login</h2>
    <p class="small muted">Insira suas credenciais corporativas.</p>
    <label>Usuário</label><input id="loginUser">
    <label>Senha</label><input id="loginPass" type="password">
    <button class="btn" style="margin-top:10px" onclick="doLogin()">Entrar</button>
    <div id="loginErr" style="display:none;color:#ffd0d0;font-weight:600;margin-top:8px">Credenciais incorretas.</div>
  </div>
</div>

<main id="app" style="display:none">
  <div class="card">
    <div class="tabs">
      <button class="tab-btn active" data-tab="projeto" onclick="switchTab(event,'projeto')">Novo Projeto</button>
      <button class="tab-btn" data-tab="indices" onclick="switchTab(event,'indices')">Índices</button>
      <button class="tab-btn" data-tab="fornecedores" onclick="switchTab(event,'fornecedores')">Fornecedores</button>
      <button class="tab-btn" data-tab="cadastro" onclick="switchTab(event,'cadastro')">Manutenção Fornecedores</button>
      <button class="tab-btn" data-tab="clientes" onclick="switchTab(event,'clientes')">Clientes</button>
      <button class="tab-btn" data-tab="orcamentistas" onclick="switchTab(event,'orcamentistas')">Orçamentistas</button>
      <button class="tab-btn" data-tab="projetos" onclick="switchTab(event,'projetos')">Histórico de Projetos</button>
      <button class="tab-btn" data-tab="dashboard" onclick="switchTab(event,'dashboard')">Dashboard</button>
      <button class="tab-btn" data-tab="sobre" onclick="switchTab(event,'sobre')">Sobre</button>
    </div>

    <section id="projeto" class="section active">
      <h2>Novo Projeto</h2>
      <div class="row">
        <div class="col-6">
          <label>Nome do projeto</label>
          <input id="projNome" placeholder="Ex.: Flange usinado + pintura">
        </div>
        <div class="col-3">
            <label>Data de Início</label>
            <input type="date" id="projDataInicio">
        </div>
        <div class="col-3">
            <label>Orçamentista</label>
            <select id="projOrc"></select>
        </div>
        
        <div class="col-6">
            <label>Cliente</label>
            <select id="projCli"></select>
        </div>
        <div class="col-6">
          <label>Descrição</label>
          <input id="projDesc" placeholder="Detalhes adicionais...">
        </div>

        <div class="col-12">
            <div class="divider"></div>
            
            <div style="display:flex; align-items:center; gap:20px; flex-wrap:wrap;">
                <label class="checkbox-label" style="font-weight:bold;">
                    <input type="checkbox" id="checkSwot" onchange="toggleSwot()"> Adicionar Matriz SWOT/FOFA (Opcional)
                </label>
                
                <label class="checkbox-label" style="font-weight:bold;">
                    <input type="checkbox" id="checkIshikawa" onchange="toggleIshikawa()"> Adicionar Diagrama de Ishikawa (Opcional)
                </label>
            </div>
            
            <div id="swotArea" style="display:none; margin-top:10px;">
                <h3 class="small muted">Matriz SWOT</h3>
                <div class="swot-container">
                    <div class="swot-card bg-yellow"><h4>Forças (F)</h4><textarea id="swotF" placeholder="Interno: Pontos fortes..."></textarea></div>
                    <div class="swot-card bg-red"><h4>Oportunidades (O)</h4><textarea id="swotO" placeholder="Externo: Oportunidades..."></textarea></div>
                    <div class="swot-card bg-green"><h4>Fraquezas (F)</h4><textarea id="swotWr" placeholder="Interno: Pontos fracos..."></textarea></div>
                    <div class="swot-card bg-blue"><h4>Ameaças (A)</h4><textarea id="swotA" placeholder="Externo: Ameaças..."></textarea></div>
                </div>
            </div>

            <div id="ishikawaArea" style="display:none; margin-top:15px;">
                <h3 class="small muted">Diagrama de Ishikawa (Causa e Efeito)</h3>
                <div class="fishbone-wrapper">
                    <div class="fish-container">
                        <div class="fish-ribs">
                            <div class="fish-spine"></div>
                            <div class="fish-row top">
                                <div class="fish-bone-box">
                                    <div class="fish-input-card">
                                        <span class="fish-label">Máquina</span>
                                        <textarea id="ishi_maq" placeholder="Falhas, manutenção..."></textarea>
                                    </div>
                                </div>
                                <div class="fish-bone-box">
                                    <div class="fish-input-card">
                                        <span class="fish-label">Método</span>
                                        <textarea id="ishi_met" placeholder="Procedimentos, regras..."></textarea>
                                    </div>
                                </div>
                                <div class="fish-bone-box">
                                    <div class="fish-input-card">
                                        <span class="fish-label">Material</span>
                                        <textarea id="ishi_mat" placeholder="Matéria-prima, defeitos..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="fish-row bottom">
                                <div class="fish-bone-box">
                                    <div class="fish-input-card">
                                        <span class="fish-label">Mão de Obra</span>
                                        <textarea id="ishi_mao" placeholder="Treinamento, erros..."></textarea>
                                    </div>
                                </div>
                                <div class="fish-bone-box">
                                    <div class="fish-input-card">
                                        <span class="fish-label">Meio Ambiente</span>
                                        <textarea id="ishi_amb" placeholder="Espaço, clima, layout..."></textarea>
                                    </div>
                                </div>
                                <div class="fish-bone-box">
                                    <div class="fish-input-card">
                                        <span class="fish-label">Medida</span>
                                        <textarea id="ishi_med" placeholder="Calibração, indicadores..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fish-head">
                            <div class="fish-head-shape">
                                <label>PROBLEMA / EFEITO</label>
                                <input type="text" id="ishi_prob" placeholder="Descreva o problema principal">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="divider"></div>
        </div>

        <div class="col-12">
          <h3>Áreas (pelo menos 1)</h3>
          <div id="areasWrap" class="row"></div>
          <button class="btn" style="margin-top:8px" onclick="addAreaRow()">+ Adicionar área</button>
          <div style="text-align:right; padding:10px; font-weight:bold;">Total Pesos Áreas: <span id="totalPesoAreaDisplay">10</span>%</div>
        </div>

        <div class="col-12">
          <h3>Índices do projeto</h3>
          <div class="small muted" style="color:var(--accent)">Importante: A soma dos pesos deve ser EXATAMENTE 100.</div>
          <table>
            <thead><tr><th>Incluir</th><th>Índice</th><th>Peso (%)</th><th>Descrição</th></tr></thead>
            <tbody id="idxBody"></tbody>
          </table>
          <div style="text-align:right; padding:10px; font-weight:bold;">Total Pesos Índices: <span id="totalPesoDisplay">0</span>%</div>
        </div>

        <div class="col-12">
          <div class="legend">
            <strong>Legenda de cores (score):</strong>
            <span><span class="box" style="background:var(--green)"></span> 7 a 10</span>
            <span><span class="box" style="background:var(--yellow)"></span> 4 a 6,99</span>
            <span><span class="box" style="background:var(--red)"></span> 0 a 3,99</span>
          </div>
        </div>

        <div class="col-12">
          <button class="btn" onclick="calcular()">Calcular e Salvar</button>
        </div>

        <div class="col-12" id="resTable"></div>
        <div class="col-12"><canvas id="resChart" height="120"></canvas></div>
      </div>
    </section>

    <section id="indices" class="section">
        <h2>Gerenciar Índices</h2>
        <div class="card">
            <div class="row">
                <div class="col-2"><input id="indId" placeholder="ID (ex: I16)"></div>
                <div class="col-4"><input id="indNome" placeholder="Nome do Índice"></div>
                <div class="col-2">
                    <select id="indScope">
                        <option value="area">Área</option>
                        <option value="global">Global</option>
                    </select>
                </div>
                <div class="col-4"><input id="indDesc" placeholder="Descrição"></div>
                <div class="col-12"><button class="btn" onclick="addInd()">Salvar Índice</button></div>
            </div>
        </div>
        <div id="listInd"></div>
    </section>

    <section id="fornecedores" class="section">
      <h2>Base de Fornecedores</h2>
      <div class="row">
        <div class="col-6">
          <label>Notas por área (opcional)</label>
          <select id="filtroAreaNotas" onchange="renderFornecedores()">
            <option value="">(selecionar área para exibir notas da área)</option>
          </select>
        </div>
        <div class="col-6" style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn ghost" onclick="renderFornecedores(true)">Limpar filtro</button>
        </div>
        <div class="col-12" id="fornList"></div>
      </div>
    </section>

    <section id="cadastro" class="section">
      <h2>Manutenção/Cadastro de Fornecedores</h2>
      <div class="row">
        <div class="col-3"><label>ID</label><input id="c_id" placeholder="Ex.: F120"></div>
        <div class="col-6"><label>Nome</label><input id="c_nome" placeholder="Ex.: MetalPrime Serviços"></div>
        <div class="col-3" style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" onclick="salvarFornecedor()">Salvar</button>
          <button class="btn secondary" onclick="limparCadastro()">Limpar</button>
        </div>

        <div class="col-12"><div class="divider"></div></div>

        <div class="col-12">
          <h3>Áreas atendidas</h3>
          <div id="c_areas" class="row"></div>
        </div>
        
        <div class="col-12"><div class="divider"></div></div>

        <div class="col-6">
          <h3>Notas globais (0–10)</h3>
          <div id="c_notasGlobais"></div>
        </div>

        <div class="col-12">
            <div class="divider"></div>
          <h3>Notas por área (0–10)</h3>
          <div class="small muted" style="margin-bottom:10px">Selecione as áreas acima para abrir os campos de preenchimento.</div>
          <div id="c_notasPorArea"></div>
        </div>
      </div>
    </section>

    <section id="clientes" class="section">
        <h2>Gerenciar Clientes</h2>
        <div class="row">
            <div class="col-9"><input id="newCli" placeholder="Nome do Cliente / Empresa"></div>
            <div class="col-3"><button class="btn" onclick="addCli()">Adicionar</button></div>
            <div class="col-12" id="listCli"></div>
        </div>
    </section>

    <section id="orcamentistas" class="section">
        <h2>Gerenciar Orçamentistas</h2>
        <div class="row">
            <div class="col-9"><input id="newOrc" placeholder="Nome do Orçamentista"></div>
            <div class="col-3"><button class="btn" onclick="addOrc()">Adicionar</button></div>
            <div class="col-12" id="listOrc"></div>
        </div>
    </section>

    <section id="projetos" class="section">
      <h2>Projetos Executados</h2>
      <div id="projHist"></div>
    </section>

    <section id="dashboard" class="section">
        <h2>Visão Geral</h2>
         <div class="filter-bar">
            <div class="filter-group">
                <label>Status</label>
                <select id="dbF_status" onchange="renderDashboard()">
                    <option value="">Todos</option>
                    <option value="A iniciar">A iniciar</option>
                    <option value="Em andamento">Em andamento</option>
                    <option value="Concluído">Concluído</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Orçamentista</label>
                <select id="dbF_orc" onchange="renderDashboard()"></select>
            </div>
            <div class="filter-group">
                <label>Cliente</label>
                <select id="dbF_cli" onchange="renderDashboard()"></select>
            </div>
            <div class="filter-group" style="flex:0">
                <button class="btn secondary" onclick="clearDbFilters()">Limpar</button>
            </div>
         </div>

        <div class="row">
            <div class="col-4 stat-card">
                <div class="stat-val" id="db_total">0</div>
                <div class="stat-label">Projetos Filtrados</div>
            </div>
            <div class="col-4 stat-card">
                <div class="stat-val" id="db_andamento" style="color:var(--yellow)">0</div>
                <div class="stat-label">Em Andamento</div>
            </div>
            <div class="col-4 stat-card">
                <div class="stat-val" id="db_concluido" style="color:var(--green)">0</div>
                <div class="stat-label">Concluídos</div>
            </div>
        </div>
        <div class="row" style="margin-top:20px">
            <div class="col-6">
                <div class="card">
                    <h3>Projetos por Orçamentista (Filtrados)</h3>
                    <canvas id="chartOrc" height="200"></canvas>
                </div>
            </div>
            <div class="col-6">
                <div class="card">
                    <h3>Projetos por Cliente (Filtrados)</h3>
                    <canvas id="chartCli" height="200"></canvas>
                </div>
            </div>
        </div>
    </section>

    <section id="sobre" class="section">
      <h2>Sobre o Cálculo</h2>
      <p class="muted">Este sistema utiliza o método de <strong>Média Ponderada (Weighted Sum Model)</strong> para classificar fornecedores.</p>
      
      <div class="card" style="background:var(--card2)">
        <h3>1. Estrutura de Pesos</h3>
        <ul>
            <li><strong>Pesos dos Índices:</strong> O usuário define pesos para critérios (ex: Qualidade = 30%, Preço = 20%...). A soma deve ser obrigatoriamente 100%.</li>
            <li><strong>Pesos das Áreas:</strong> O usuário define a importância de cada processo produtivo no projeto (ex: Usinagem = 80%, Pintura = 20%). A soma também deve ser obrigatoriamente 100%.</li>
        </ul>

        <h3>2. Cálculo do Score por Área</h3>
        <p>Para cada área $j$ e fornecedor $F$, calcula-se o score parcial ($S_{j}$):</p>
        <p style="font-family:monospace; background:#000; padding:10px; border-radius:8px;">
            S_j = Σ (Nota_i × Peso_i)
        </p>
        <p class="small">Onde $Nota_i$ é a nota do índice $i$ naquela área (ou nota global se for um índice global) e $Peso_i$ é o peso decimal do índice.</p>

        <h3>3. Cálculo do Score Final</h3>
        <p>O score final do fornecedor é a média ponderada dos scores das áreas:</p>
        <p style="font-family:monospace; background:#000; padding:10px; border-radius:8px;">
            ScoreFinal = Σ (S_j × PesoArea_j)
        </p>
        
        <h3>4. Critério de Corte</h3>
        <p>Apenas fornecedores que possuem capacidade produtiva cadastrada em <strong>TODAS</strong> as áreas solicitadas pelo projeto são incluídos no ranking.</p>
      </div>
    </section>
  </div>
</main>

<footer>SelectSupplier — Protótipo funcional v2.2</footer>

<script>
/* ===================== CONFIG INICIAL ===================== */
const INITIAL_INDICES = [
  { id:"I1",  nome:"Qualidade", scope:"area", desc:"Nível de conformidade técnica, acabamento superficial e aderência às tolerâncias de desenho." },
  { id:"I2",  nome:"Tempo de Entrega", scope:"area", desc:"Histórico de cumprimento de prazos (OTD), lead time e previsibilidade logística." },
  { id:"I3",  nome:"Custo", scope:"area", desc:"Competitividade da proposta comercial em relação à média de mercado e breakdown de custos." },
  { id:"I4",  nome:"Flexibilidade", scope:"area", desc:"Capacidade de adaptação a alterações de engenharia, mix de produtos ou urgências de volume." },
  { id:"I5",  nome:"Acuracidade Doc.", scope:"global", desc:"Precisão na emissão de notas fiscais, certificados de matéria-prima e laudos de qualidade." },
  { id:"I6",  nome:"Reclamações Téc.", scope:"area", desc:"Índice histórico de não-conformidades (RNCs) e rejeições em recebimento." },
  { id:"I7",  nome:"Normas Amb.", scope:"global", desc:"Adesão a práticas ESG, ISO 14001 e gestão correta de resíduos industriais." },
  { id:"I8",  nome:"Comunicação", scope:"global", desc:"Facilidade de contato, transparência nas informações e tempo médio de resposta." },
  { id:"I9",  nome:"Inovação", scope:"area", desc:"Proatividade na sugestão de melhorias de processo, redução de custo ou novos materiais." },
  { id:"I10", nome:"Confiabilidade Fin.", scope:"global", desc:"Saúde financeira da empresa, risco de falência ou interrupção por falta de capital de giro." },
  { id:"I11", nome:"Capacidade Téc.", scope:"area", desc:"Parque fabril atualizado, tecnologia de máquinas e expertise técnica da equipe." },
  { id:"I12", nome:"Logística", scope:"area", desc:"Qualidade da embalagem, rastreabilidade do transporte e cumprimento de janelas de entrega." },
  { id:"I13", nome:"Compliance", scope:"global", desc:"Regularidade fiscal, trabalhista e ética corporativa (Compliance e Governança)." },
  { id:"I14", nome:"Pós-venda", scope:"global", desc:"Agilidade na resolução de problemas, garantias e suporte técnico continuado." },
  { id:"I15", nome:"Satisfação Interna", scope:"area", desc:"Percepção qualitativa dos stakeholders internos (Engenharia, Qualidade, PCP)." }
];

const INITIAL_ORCS = ["Bruno Ullmann", "Lucas Sitieni", "Pedro Schech", "Rafael Hirt"];
const INITIAL_CLIENTS = [
    "Construtora Alpha", "Beta Engenharia", "Gamma Soluções", "Delta Indústria",
    "Epsilon Tech", "Zeta Montagens", "Eta Processos", "Theta Manutenção",
    "Iota Alimentos", "Kappa Logística", "Lambda Químicos", "Mu Farmacêutica",
    "Nu Têxtil", "Xi Papel e Celulose", "Omicron Varejo", "Pi Energia",
    "Rho Saneamento", "Sigma Mineração", "Tau Automotiva", "Upsilon Naval"
];

const AREAS = [
  { id:"A1",  nome:"Usinagem" }, { id:"A2",  nome:"Soldagem" }, { id:"A3",  nome:"Fundição" },
  { id:"A4",  nome:"Injeção Plástica" }, { id:"A5",  nome:"Impressão 3D" }, { id:"A6",  nome:"Software / Automação" },
  { id:"A7",  nome:"Tratamento Térmico" }, { id:"A8",  nome:"Caldeiraria" }, { id:"A9",  nome:"Metrologia 3D" },
  { id:"A10", nome:"Corte a Laser / Dobra" }, { id:"A11", nome:"Pintura / Acabamento" }, { id:"A12", nome:"Extrusão" },
  { id:"A13", nome:"Rotomoldagem" }, { id:"A14", nome:"Montagem e Acabamento" }, { id:"A15", nome:"Fabricação de Moldes" }
];

/* Base de fornecedores COMPLETA */
const BASE_FORNECEDORES = [
  { id:"F1", nome:"MecanizaPro", areas:["A1","A2","A3"], notas:{
      global:{ I5:8,I7:7,I8:8,I10:7,I13:7,I14:7 },
      porArea:{
        A1:{ I1:8,I2:6,I3:7,I4:6,I6:8,I9:7,I11:8,I12:7,I15:8 },
        A2:{ I1:6,I2:6,I3:7,I4:5,I6:7,I9:5,I11:6,I12:6,I15:6 },
        A3:{ I1:5,I2:4,I3:5,I4:5,I6:6,I9:5,I11:5,I12:5,I15:5 }
      }
  }},
  { id:"F2", nome:"Usinax", areas:["A1","A2","A5","A10"], notas:{
      global:{ I5:7,I7:8,I8:7,I10:6,I13:7,I14:7 },
      porArea:{
        A1:{ I1:7,I2:8,I3:6,I4:7,I6:8,I9:6,I11:8,I12:8,I15:7 },
        A2:{ I1:7,I2:7,I3:6,I4:6,I6:7,I9:5,I11:6,I12:6,I15:6 },
        A5:{ I1:8,I2:7,I3:8,I4:6,I6:7,I9:8,I11:7,I12:7,I15:7 },
        A10:{ I1:7,I2:8,I3:7,I4:6,I6:7,I9:6,I11:8,I12:8,I15:7 }
      }
  }},
  { id:"F3", nome:"SmartAutomate", areas:["A6"], notas:{
      global:{ I5:9,I7:9,I8:9,I10:9,I13:9,I14:9 },
      porArea:{ A6:{ I1:9,I2:8,I3:8,I4:7,I6:9,I9:9,I11:8,I12:8,I15:9 } }
  }},
  { id:"F4", nome:"MetalPrime", areas:["A8","A7","A10"], notas:{
      global:{ I5:7,I7:7,I8:7,I10:7,I13:7,I14:7 },
      porArea:{
        A8:{ I1:6,I2:6,I3:6,I4:6,I6:7,I9:5,I11:6,I12:6,I15:6 },
        A7:{ I1:7,I2:7,I3:7,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 },
        A10:{ I1:8,I2:8,I3:7,I4:6,I6:7,I9:6,I11:8,I12:8,I15:7 }
      }
  }},
  { id:"F5", nome:"GreenPlast", areas:["A4","A11"], notas:{
      global:{ I5:8,I7:9,I8:7,I10:8,I13:8,I14:8 },
      porArea:{
        A4:{ I1:8,I2:7,I3:7,I4:7,I6:8,I9:7,I11:7,I12:7,I15:8 },
        A11:{ I1:7,I2:7,I3:6,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 }
      }
  }},
  { id:"F6", nome:"LaserShape", areas:["A10","A1"], notas:{
      global:{ I5:8,I7:8,I8:8,I10:7,I13:7,I14:7 },
      porArea:{
        A10:{ I1:8,I2:8,I3:7,I4:7,I6:8,I9:7,I11:8,I12:8,I15:7 },
        A1:{  I1:7,I2:7,I3:6,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 }
      }
  }},
  { id:"F7", nome:"MetriScan", areas:["A9"], notas:{
      global:{ I5:9,I7:9,I8:8,I10:8,I13:9,I14:8 },
      porArea:{ A9:{ I1:9,I2:8,I3:7,I4:6,I6:8,I9:8,I11:9,I12:8,I15:8 } }
  }},
  { id:"F8", nome:"TecnoWeld", areas:["A2"], notas:{
      global:{ I5:7,I7:7,I8:6,I10:7,I13:7,I14:7 },
      porArea:{ A2:{ I1:8,I2:6,I3:6,I4:6,I6:7,I9:6,I11:6,I12:6,I15:7 } }
  }},
  { id:"F9", nome:"AutoPaint", areas:["A11"], notas:{
      global:{ I5:7,I7:8,I8:7,I10:8,I13:8,I14:8 },
      porArea:{ A11:{ I1:8,I2:7,I3:6,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 } }
  }},
  { id:"F10", nome:"ProtoPrint3D", areas:["A5"], notas:{
      global:{ I5:7,I7:7,I8:7,I10:7,I13:7,I14:7 },
      porArea:{ A5:{ I1:7,I2:7,I3:7,I4:6,I6:7,I9:8,I11:7,I12:7,I15:7 } }
  }},
  { id:"F11", nome:"AeroMetals", areas:["A1","A2","A3"], notas:{
      global:{ I5:8,I7:8,I8:7,I10:8,I13:8,I14:8 },
      porArea:{
        A1:{ I1:9,I2:7,I3:6,I4:8,I6:8,I9:8,I11:8,I12:8,I15:9 },
        A2:{ I1:7,I2:7,I3:6,I4:6,I6:7,I9:6,I11:6,I12:6,I15:7 },
        A3:{ I1:6,I2:5,I3:6,I4:6,I6:6,I9:5,I11:6,I12:6,I15:6 }
      }
  }},
  { id:"F12", nome:"TurboMec", areas:["A1","A2"], notas:{
      global:{ I5:7,I7:7,I8:6,I10:6,I13:7,I14:6 },
      porArea:{
        A1:{ I1:8,I2:6,I3:6,I4:8,I6:7,I9:7,I11:7,I12:7,I15:8 },
        A2:{ I1:7,I2:6,I3:6,I4:6,I6:7,I9:5,I11:6,I12:6,I15:6 }
      }
  }},
  { id:"F13", nome:"ForgeMix", areas:["A1","A2","A7"], notas:{
      global:{ I5:7,I7:7,I8:7,I10:7,I13:7,I14:7 },
      porArea:{
        A1:{ I1:8,I2:7,I3:7,I4:7,I6:7,I9:6,I11:7,I12:7,I15:8 },
        A2:{ I1:7,I2:7,I3:6,I4:6,I6:7,I9:6,I11:6,I12:6,I15:7 },
        A7:{ I1:7,I2:6,I3:6,I4:6,I6:6,I9:5,I11:6,I12:6,I15:6 }
      }
  }},
  { id:"F14", nome:"Proweld Machining", areas:["A1","A2"], notas:{
      global:{ I5:8,I7:7,I8:7,I10:7,I13:7,I14:7 },
      porArea:{
        A1:{ I1:8,I2:8,I3:7,I4:7,I6:8,I9:7,I11:8,I12:8,I15:8 },
        A2:{ I1:7,I2:7,I3:6,I4:6,I6:7,I9:6,I11:6,I12:6,I15:7 }
      }
  }},
  { id:"F15", nome:"SteelCraft", areas:["A1","A2","A8"], notas:{
      global:{ I5:7,I7:7,I8:7,I10:7,I13:7,I14:7 },
      porArea:{
        A1:{ I1:7,I2:7,I3:6,I4:7,I6:7,I9:6,I11:7,I12:7,I15:7 },
        A2:{ I1:8,I2:6,I3:6,I4:6,I6:7,I9:5,I11:6,I12:6,I15:7 },
        A8:{ I1:7,I2:6,I3:6,I4:6,I6:6,I9:5,I11:6,I12:6,I15:6 }
      }
  }},
  { id:"F16", nome:"Weld&Mill", areas:["A1","A2"], notas:{
      global:{ I5:8,I7:8,I8:8,I10:7,I13:8,I14:8 },
      porArea:{
        A1:{ I1:9,I2:8,I3:7,I4:8,I6:8,I9:7,I11:8,I12:8,I15:9 },
        A2:{ I1:8,I2:7,I3:6,I4:6,I6:7,I9:6,I11:6,I12:6,I15:7 }
      }
  }},
  { id:"F17", nome:"MaxForge", areas:["A3","A7"], notas:{
      global:{ I5:7,I7:6,I8:6,I10:6,I13:7,I14:6 },
      porArea:{
        A3:{ I1:7,I2:5,I3:6,I4:6,I6:6,I9:5,I11:6,I12:6,I15:6 },
        A7:{ I1:7,I2:6,I3:6,I4:6,I6:6,I9:5,I11:6,I12:6,I15:6 }
      }
  }},
  { id:"F18", nome:"PlastiForm", areas:["A4"], notas:{
      global:{ I5:8,I7:8,I8:7,I10:7,I13:8,I14:7 },
      porArea:{ A4:{ I1:7,I2:7,I3:7,I4:7,I6:7,I9:7,I11:7,I12:7,I15:7 } }
  }},
  { id:"F19", nome:"Rotomax", areas:["A13"], notas:{
      global:{ I5:7,I7:7,I8:7,I10:7,I13:7,I14:7 },
      porArea:{ A13:{ I1:7,I2:6,I3:7,I4:6,I6:7,I9:6,I11:6,I12:6,I15:6 } }
  }},
  { id:"F20", nome:"PaintFlex", areas:["A11","A10"], notas:{
      global:{ I5:7,I7:8,I8:7,I10:8,I13:8,I14:8 },
      porArea:{
        A11:{ I1:8,I2:7,I3:6,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 },
        A10:{ I1:7,I2:8,I3:7,I4:6,I6:7,I9:6,I11:8,I12:8,I15:7 }
      }
  }},
  { id:"F21", nome:"MeasureTech", areas:["A9","A6"], notas:{
      global:{ I5:9,I7:9,I8:8,I10:8,I13:9,I14:8 },
      porArea:{
        A9:{ I1:9,I2:8,I3:7,I4:6,I6:8,I9:8,I11:9,I12:8,I15:8 },
        A6:{ I1:8,I2:8,I3:8,I4:7,I6:8,I9:8,I11:8,I12:8,I15:9 }
      }
  }},
  { id:"F22", nome:"InduParts", areas:["A1","A2","A14"], notas:{
      global:{ I5:7,I7:7,I8:7,I10:7,I13:7,I14:7 },
      porArea:{
        A1:{ I1:7,I2:7,I3:7,I4:7,I6:7,I9:6,I11:7,I12:7,I15:7 },
        A2:{ I1:7,I2:6,I3:6,I4:6,I6:7,I9:5,I11:6,I12:6,I15:6 },
        A14:{ I1:7,I2:7,I3:7,I4:6,I6:7,I9:6,I11:7,I12:7,I15:7 }
      }
  }},
  /* 3. NOVOS FORNECEDORES PARA A12 e A15 */
  { id:"F23", nome:"ExtrusaPack", areas:["A12"], notas:{
      global:{ I5:8,I7:8,I8:7,I10:7,I13:8,I14:7 },
      porArea:{ A12:{ I1:7,I2:8,I3:8,I4:6,I6:7,I9:6,I11:7,I12:8,I15:7 } }
  }},
  { id:"F24", nome:"Moldes Precision", areas:["A15"], notas:{
      global:{ I5:9,I7:7,I8:8,I10:8,I13:8,I14:8 },
      porArea:{ A15:{ I1:9,I2:7,I3:6,I4:8,I6:8,I9:8,I11:9,I12:7,I15:8 } }
  }}
];

/* ===================== ESTADO / STORAGE ===================== */
const SK_SUP = "ss_v5_suppliers";
const SK_PROJ = "ss_v5_projects";
const SK_ORC = "ss_v5_orcamentistas";
const SK_CLI = "ss_v5_clientes";
const SK_IND = "ss_v5_indices";

let suppliers = [];
let projects = [];
let orcamentistas = [];
let clientes = [];
let indicesList = [];
let chartRes = null;
let dashboardCharts = { orc: null, cli: null };

function loadState(){
  try{ suppliers = JSON.parse(localStorage.getItem(SK_SUP)||"null"); }catch(_){ suppliers=null; }
  if(!Array.isArray(suppliers) || suppliers.length===0) suppliers = structuredClone(BASE_FORNECEDORES);

  try{ projects = JSON.parse(localStorage.getItem(SK_PROJ)||"null"); }catch(_){ projects=null; }
  if(!Array.isArray(projects)) projects = [];

  try{ orcamentistas = JSON.parse(localStorage.getItem(SK_ORC)||"null"); }catch(_){ orcamentistas=null; }
  if(!Array.isArray(orcamentistas) || orcamentistas.length===0) orcamentistas = [...INITIAL_ORCS];

  try{ clientes = JSON.parse(localStorage.getItem(SK_CLI)||"null"); }catch(_){ clientes=null; }
  if(!Array.isArray(clientes) || clientes.length===0) clientes = [...INITIAL_CLIENTS];

  try{ indicesList = JSON.parse(localStorage.getItem(SK_IND)||"null"); }catch(_){ indicesList=null; }
  if(!Array.isArray(indicesList) || indicesList.length===0) indicesList = structuredClone(INITIAL_INDICES);
}

function saveData(){ 
    localStorage.setItem(SK_SUP, JSON.stringify(suppliers));
    localStorage.setItem(SK_PROJ, JSON.stringify(projects));
    localStorage.setItem(SK_ORC, JSON.stringify(orcamentistas));
    localStorage.setItem(SK_CLI, JSON.stringify(clientes));
    localStorage.setItem(SK_IND, JSON.stringify(indicesList));
}

/* ===================== LOGIN ===================== */
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(u==="adm" && p==="123"){
    document.getElementById('loginOverlay').style.display="none";
    document.getElementById('app').style.display="block";
    initUI();
  }else{
    document.getElementById('loginErr').style.display="block";
  }
}

/* ===================== UI BASICS ===================== */
function switchTab(ev,id){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  ev.target.classList.add("active");
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  
  if(id==="dashboard"){ renderDbFilters(); renderDashboard(); }
  if(id==="fornecedores") renderFornecedores();
  if(id==="cadastro") renderCadastro();
  if(id==="projetos") renderProjetos();
  if(id==="orcamentistas") renderOrc();
  if(id==="clientes") renderCli();
  if(id==="indices") renderInd();
  if(id==="projeto") updateProjectSelects();
}

function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function colorByScore(v){ if(v>=7) return getVar('--green'); if(v>=4) return getVar('--yellow'); return getVar('--red'); }
function clamp(n,min,max){ n=Number(n); if(isNaN(n)) return 0; return Math.min(Math.max(n,min),max); }

/* ===================== CRUD GENÉRICO ===================== */
// Orçamentistas
function renderOrc(){
    document.getElementById('listOrc').innerHTML = `<table>
        <thead><tr><th>Nome</th><th>Ações</th></tr></thead>
        <tbody>${orcamentistas.map((n,i)=>`<tr><td>${n}</td><td>
            <button class="btn secondary small" onclick="editOrc(${i})">Editar</button>
            <button class="btn danger small" onclick="delOrc(${i})">Excluir</button>
        </td></tr>`).join('')}</tbody>
    </table>`;
}
function addOrc(){
    const val = document.getElementById('newOrc').value.trim();
    if(val){ orcamentistas.push(val); document.getElementById('newOrc').value=""; saveData(); renderOrc(); }
}
function delOrc(i){ if(confirm("Excluir?")) { orcamentistas.splice(i,1); saveData(); renderOrc(); } }
function editOrc(i){
    const novo = prompt("Novo nome:", orcamentistas[i]);
    if(novo!==null && novo.trim()!==""){ orcamentistas[i]=novo.trim(); saveData(); renderOrc(); }
}

// Clientes
function renderCli(){
    document.getElementById('listCli').innerHTML = `<table>
        <thead><tr><th>Nome</th><th>Ações</th></tr></thead>
        <tbody>${clientes.map((n,i)=>`<tr><td>${n}</td><td>
            <button class="btn secondary small" onclick="editCli(${i})">Editar</button>
            <button class="btn danger small" onclick="delCli(${i})">Excluir</button>
        </td></tr>`).join('')}</tbody>
    </table>`;
}
function addCli(){
    const val = document.getElementById('newCli').value.trim();
    if(val){ clientes.push(val); document.getElementById('newCli').value=""; saveData(); renderCli(); }
}
function delCli(i){ if(confirm("Excluir?")) { clientes.splice(i,1); saveData(); renderCli(); } }
function editCli(i){
    const novo = prompt("Novo nome:", clientes[i]);
    if(novo!==null && novo.trim()!==""){ clientes[i]=novo.trim(); saveData(); renderCli(); }
}

// Índices
function renderInd(){
    document.getElementById('listInd').innerHTML = `<table>
        <thead><tr><th>ID</th><th>Nome</th><th>Escopo</th><th>Ações</th></tr></thead>
        <tbody>${indicesList.map((ind,i)=>`<tr><td>${ind.id}</td><td>${ind.nome}</td>
            <td>${ind.scope === 'area' ? 'Área' : 'Global'}</td><td>
            <button class="btn danger small" onclick="delInd(${i})">Excluir</button>
        </td></tr>`).join('')}</tbody>
    </table>`;
}
function addInd(){
    const id = document.getElementById('indId').value.trim();
    const nome = document.getElementById('indNome').value.trim();
    const scope = document.getElementById('indScope').value;
    const desc = document.getElementById('indDesc').value.trim();
    if(!id || !nome){ alert("ID e Nome obrigatórios"); return; }
    indicesList.push({id,nome,scope,desc});
    saveData(); renderInd();
    document.getElementById('indId').value=""; document.getElementById('indNome').value="";
}
function delInd(i){ if(confirm("Excluir?")) { indicesList.splice(i,1); saveData(); renderInd(); } }


/* ===================== PROJETO ===================== */
function updateProjectSelects(){
    const selO = document.getElementById('projOrc');
    selO.innerHTML = `<option value="">Selecione...</option>` + orcamentistas.map(o=>`<option>${o}</option>`).join('');
    
    const selC = document.getElementById('projCli');
    selC.innerHTML = `<option value="">Selecione...</option>` + clientes.map(c=>`<option>${c}</option>`).join('');
}

function toggleSwot(){
    const chk = document.getElementById('checkSwot');
    document.getElementById('swotArea').style.display = chk.checked ? 'block' : 'none';
}

function toggleIshikawa(){
    const chk = document.getElementById('checkIshikawa');
    document.getElementById('ishikawaArea').style.display = chk.checked ? 'block' : 'none';
}

function addAreaRow(){
  const wrap = document.getElementById('areasWrap');
  const idx = wrap.querySelectorAll('.card').length;
  const row = document.createElement('div');
  row.className="col-12";
  row.innerHTML = `
    <div class="card" style="padding:10px">
      <div class="row">
        <div class="col-6">
          <label>Área</label>
          <select class="area-select">${AREAS.map(a=>`<option value="${a.id}">${a.nome}</option>`).join("")}</select>
        </div>
        <div class="col-4">
          <label>Peso da área (%)</label>
          <input class="area-weight" type="number" min="0" max="100" value="10" oninput="updateTotalAreaWeight()">
        </div>
        <div class="col-2" style="display:flex;align-items:flex-end;">
          <button class="btn secondary remove-area" ${idx===0?'disabled':''}>Remover</button>
        </div>
      </div>
    </div>`;
  wrap.appendChild(row);
  row.querySelector('.remove-area').onclick = () => { if(idx>0) row.remove(); updateTotalAreaWeight(); };
  updateTotalAreaWeight();
}

function updateTotalAreaWeight(){
    let sum = 0;
    document.querySelectorAll('.area-weight').forEach(i=>{
        sum += Number(i.value)||0;
    });
    const el = document.getElementById('totalPesoAreaDisplay');
    el.textContent = sum;
    el.style.color = sum===100 ? 'var(--green)' : 'var(--red)';
}

function renderIndicesTableForProject(){
  const tb = document.getElementById('idxBody');
  tb.innerHTML = "";
  indicesList.forEach(ind=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="idx-inc" data-id="${ind.id}" checked onchange="updateTotalWeight()"></td>
      <td>${ind.id} — ${ind.nome}</td>
      <td><input type="number" class="idx-weight" data-id="${ind.id}" min="0" max="100" value="0" oninput="updateTotalWeight()"></td>
      <td class="small muted">${ind.desc||""}</td>
    `;
    tb.appendChild(tr);
  });
}

function updateTotalWeight(){
    let sum = 0;
    document.querySelectorAll('.idx-inc:checked').forEach(chk=>{
        const id = chk.dataset.id;
        const val = Number(document.querySelector(`.idx-weight[data-id='${id}']`).value)||0;
        sum += val;
    });
    const el = document.getElementById('totalPesoDisplay');
    el.textContent = sum;
    el.style.color = sum===100 ? 'var(--green)' : 'var(--red)';
}

function calcular(){
  // Validações básicas
  const name = (document.getElementById('projNome').value||"").trim();
  const orc = document.getElementById('projOrc').value;
  const cli = document.getElementById('projCli').value;
  const dataInicio = document.getElementById('projDataInicio').value; 

  if(!name){ alert("Nome do projeto é obrigatório."); return; }
  if(!orc || !cli){ alert("Selecione Orçamentista e Cliente."); return; }

  // 1. Validação Soma 100 ÍNDICES
  let sumW = 0;
  const idxRows = indicesList.map(ind=>{
    const chk = document.querySelector(`.idx-inc[data-id='${ind.id}']`);
    if(!chk || !chk.checked) return null;
    const w = Number(document.querySelector(`.idx-weight[data-id='${ind.id}']`).value)||0;
    sumW += w;
    return { ...ind, inc:true, peso:w };
  }).filter(r=>r);

  if(sumW !== 100){
      alert(`ERRO: A soma dos pesos dos ÍNDICES deve ser exatamente 100%. Soma atual: ${sumW}%`);
      return;
  }

  // 2. Validação Soma 100 ÁREAS
  const areaRows = [...document.querySelectorAll('#areasWrap .card')].map(card=>{
    const id = card.querySelector('.area-select').value;
    const peso = Number(card.querySelector('.area-weight').value)||0;
    return { id, peso };
  });
  if(!areaRows.length){ alert("Adicione ao menos 1 área."); return; }
  
  const sumArea = areaRows.reduce((a,b)=>a+b.peso,0);
  if(sumArea !== 100){
      alert(`ERRO: A soma dos pesos das ÁREAS deve ser exatamente 100%. Soma atual: ${sumArea}%`);
      return;
  }
  
  // Normalizar pesos para decimal (dividir por 100)
  const areasW = areaRows.map(a=>({...a, w: a.peso/100}));
  const idxW = idxRows.map(i=>({...i, w: i.peso/100}));

  // SWOT
  let swot = null;
  if(document.getElementById('checkSwot').checked){
      swot = {
          f: document.getElementById('swotF').value,
          o: document.getElementById('swotO').value,
          fr: document.getElementById('swotWr').value,
          a: document.getElementById('swotA').value
      };
  }

  // ISHIKAWA
  let ishikawa = null;
  if(document.getElementById('checkIshikawa').checked){
      ishikawa = {
          maquina: document.getElementById('ishi_maq').value,
          metodo: document.getElementById('ishi_met').value,
          material: document.getElementById('ishi_mat').value,
          maoobra: document.getElementById('ishi_mao').value,
          meioamb: document.getElementById('ishi_amb').value,
          medida: document.getElementById('ishi_med').value,
          problema: document.getElementById('ishi_prob').value
      };
  }

  // Cálculo
  const areasIds = areasW.map(a=>a.id);
  const considerados = suppliers.filter(f => areasIds.every(a => f.areas.includes(a)));

  const resultados = considerados.map(f=>{
    const areaScores = areasW.map(a=>{
      let s=0;
      idxW.forEach(ix=>{
        let nota=0;
        if(ix.scope==="area") nota = f.notas?.porArea?.[a.id]?.[ix.id] ?? 0;
        else nota = f.notas?.global?.[ix.id] ?? 0;
        s += nota * ix.w;
      });
      return { area:a.id, w:a.w, score:s };
    });
    const final = areaScores.reduce((acc,it)=>acc + it.score*it.w, 0);
    return { f, final, areaScores };
  }).sort((a,b)=>b.final - a.final);

  renderResultados(resultados, areasW);
  renderGrafico(resultados);

  // Salvar Projeto
  const novoProj = {
    id: Date.now(),
    nome: name,
    desc: document.getElementById('projDesc').value,
    orcamentista: orc,
    cliente: cli,
    status: "A iniciar",
    data: new Date().toISOString(),
    dataInicio: dataInicio || new Date().toISOString().split('T')[0],
    areas: areasIds.map(id => AREAS.find(x=>x.id===id)?.nome || id),
    indicesUsados: idxW,
    swot: swot,
    ishikawa: ishikawa,
    resultados: resultados.map(r=>({
        id: r.f.id, nome:r.f.nome, score: +r.final.toFixed(2), 
        areaScores: r.areaScores
    })),
    comentarios: []
  };
  
  projects.unshift(novoProj);
  saveData();
  alert("Projeto calculado e salvo no Histórico!");
}

function renderResultados(lista, areasW){
  const box = document.getElementById('resTable');
  if(!lista.length){ box.innerHTML = "<p class='muted'>Nenhum fornecedor atende a todas as áreas selecionadas.</p>"; return; }
  let head = `<tr><th>Rank</th><th>Fornecedor</th><th>Score</th>`;
  areasW.forEach(a=>{
    const nome = AREAS.find(x=>x.id===a.id)?.nome || a.id;
    head += `<th>${nome}</th>`;
  });
  head += `</tr>`;
  let body = lista.map((r,i)=>`<tr>
      <td>#${i+1}</td>
      <td>${r.f.nome}</td>
      <td><span class="pill" style="border-color:${colorByScore(r.final)}">${r.final.toFixed(2)}</span></td>
      ${r.areaScores.map(sa=>`<td>${sa.score.toFixed(2)}</td>`).join("")}
    </tr>`).join("");
  box.innerHTML = `<h3>Resultados</h3><table><thead>${head}</thead><tbody>${body}</tbody></table>`;
}

function renderGrafico(lista){
  const ctx = document.getElementById('resChart').getContext('2d');
  if(chartRes){ chartRes.destroy(); }
  const labels = lista.map(r=>r.f.nome);
  const data = lista.map(r=>+r.final.toFixed(2));
  const colors = data.map(v=>colorByScore(v));
  chartRes = new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ label:'Score', data, backgroundColor:colors, borderColor:colors }]},
    options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:10 } } }
  });
}

/* ===================== DASHBOARD ===================== */
function renderDbFilters(){
    const fOrc = document.getElementById('dbF_orc');
    const fCli = document.getElementById('dbF_cli');
    
    // Manter seleção se já existe
    const selO = fOrc.value; 
    const selC = fCli.value;

    fOrc.innerHTML = `<option value="">Todos</option>` + orcamentistas.map(o=>`<option value="${o}">${o}</option>`).join('');
    fCli.innerHTML = `<option value="">Todos</option>` + clientes.map(c=>`<option value="${c}">${c}</option>`).join('');
    
    fOrc.value = selO;
    fCli.value = selC;
}

function clearDbFilters(){
    document.getElementById('dbF_status').value = "";
    document.getElementById('dbF_orc').value = "";
    document.getElementById('dbF_cli').value = "";
    renderDashboard();
}

function renderDashboard(){
    // Filtros
    const fs = document.getElementById('dbF_status').value;
    const fo = document.getElementById('dbF_orc').value;
    const fc = document.getElementById('dbF_cli').value;

    let filtered = projects;
    if(fs) filtered = filtered.filter(p=>p.status === fs);
    if(fo) filtered = filtered.filter(p=>p.orcamentista === fo);
    if(fc) filtered = filtered.filter(p=>p.cliente === fc);

    // Stats
    const total = filtered.length;
    const emAnd = filtered.filter(p=>p.status==="Em andamento").length;
    const conc = filtered.filter(p=>p.status==="Concluído").length;
    document.getElementById('db_total').innerText = total;
    document.getElementById('db_andamento').innerText = emAnd;
    document.getElementById('db_concluido').innerText = conc;

    // Charts
    const byOrc = {}; filtered.forEach(p=>{ byOrc[p.orcamentista] = (byOrc[p.orcamentista]||0)+1; });
    const byCli = {}; filtered.forEach(p=>{ byCli[p.cliente] = (byCli[p.cliente]||0)+1; });

    renderPie(document.getElementById('chartOrc'), Object.keys(byOrc), Object.values(byOrc), 'orc');
    renderPie(document.getElementById('chartCli'), Object.keys(byCli), Object.values(byCli), 'cli');
}

function renderPie(cvs, labels, data, key){
    if(dashboardCharts[key]) dashboardCharts[key].destroy();
    dashboardCharts[key] = new Chart(cvs, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{ data: data, backgroundColor: ['#003f91','#ff6a00','#16a34a','#dc2626','#facc15','#aaa'] }]
        },
        options: { responsive:true, plugins:{ legend:{ position:'right' } } }
    });
}

/* ===================== HISTÓRICO DE PROJETOS ===================== */
function renderProjetos(){
  const div = document.getElementById('projHist');
  if(!projects.length){ div.innerHTML = `<p class="muted">Nenhum projeto salvo.</p>`; return; }

  div.innerHTML = projects.map((p,ix)=>`
    <div class="card">
      <div class="row">
        <div class="col-8">
            <h3>${p.nome}</h3>
            <p class="small muted">${p.desc||""} • Cadastrado em: ${new Date(p.data).toLocaleDateString()}</p>
            <div class="small">Início Previsto: <strong>${p.dataInicio ? new Date(p.dataInicio).toLocaleDateString() : 'N/D'}</strong></div>
            <div class="small" style="margin-top:5px">Orç.: <strong>${p.orcamentista}</strong> | Cli.: <strong>${p.cliente}</strong></div>
        </div>
        <div class="col-4" style="text-align:right">
            <label class="small">Status:</label>
            <select style="width:auto" onchange="updateStatus(${ix}, this.value)">
                <option ${p.status==='A iniciar'?'selected':''}>A iniciar</option>
                <option ${p.status==='Em andamento'?'selected':''}>Em andamento</option>
                <option ${p.status==='Concluído'?'selected':''}>Concluído</option>
            </select>
            <button class="btn secondary small" onclick="generatePDF(${ix})">PDF</button>
        </div>
        <div class="col-12"><div class="divider"></div></div>
        
        <div class="col-12">
            <h4 class="small">Histórico / Comentários</h4>
            <div style="max-height:100px; overflow-y:auto; background:#0b1424; padding:5px; border-radius:4px; margin-bottom:5px;">
                ${p.comentarios.length ? p.comentarios.map(c=>`<div class="small muted">• ${c}</div>`).join('') : '<span class="small muted">Sem comentários.</span>'}
            </div>
            <div style="display:flex; gap:5px;">
                <input id="comment_${ix}" placeholder="Adicionar comentário..." style="font-size:0.85rem">
                <button class="btn small" onclick="addComment(${ix})">Add</button>
            </div>
        </div>
      </div>
    </div>
  `).join('');
}

function updateStatus(ix, val){
    projects[ix].status = val;
    saveData();
    // não precisa re-renderizar
}
function addComment(ix){
    const inp = document.getElementById(`comment_${ix}`);
    if(inp.value.trim()){
        projects[ix].comentarios.push(`${new Date().toLocaleString()}: ${inp.value.trim()}`);
        saveData();
        renderProjetos();
    }
}

/* ===================== PDF EXPORT ===================== */
async function generatePDF(ix){
    const p = projects[ix];
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Header
    doc.setFillColor(0, 63, 145); // Navy
    doc.rect(0, 0, 210, 20, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(14);
    doc.text("SelectSupplier - Resumo do Projeto", 10, 13);

    let y = 30;
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    
    // Info Geral
    doc.setFont("helvetica", "bold"); doc.text(`Projeto: ${p.nome}`, 10, y); y+=6;
    doc.setFont("helvetica", "normal"); 
    doc.text(`Descrição: ${p.desc||"-"}`, 10, y); y+=6;
    doc.text(`Cadastrado em: ${new Date(p.data).toLocaleDateString()}`, 10, y); 
    if(p.dataInicio) {
        doc.text(`Início Previsto: ${new Date(p.dataInicio).toLocaleDateString()}`, 100, y); 
    }
    y+=6;
    doc.text(`Orçamentista: ${p.orcamentista}`, 10, y); 
    doc.text(`Cliente: ${p.cliente}`, 100, y); y+=6;
    doc.text(`Status: ${p.status}`, 10, y); y+=10;

    // Índices
    doc.setFont("helvetica", "bold"); doc.text("Índices Considerados:", 10, y); y+=6;
    const indicesData = p.indicesUsados.map(i=>[i.id, i.nome, (i.w*100).toFixed(1)+"%"]);
    doc.autoTable({
        startY: y, head: [['ID','Nome','Peso']], body: indicesData,
        theme: 'grid', styles: { fontSize: 8 }
    });
    y = doc.lastAutoTable.finalY + 10;

    // SWOT
    if(p.swot){
        if(y > 220) { doc.addPage(); y=20; }
        doc.setFontSize(10); doc.setFont("helvetica", "bold");
        doc.text("Matriz SWOT", 10, y); y+=5;
        
        const h = 25; const w = 90;
        // F
        doc.setFillColor(255, 249, 196); doc.rect(10, y, w, h, 'F');
        doc.text("FORÇAS", 12, y+5); doc.setFont("helvetica", "normal"); 
        doc.text(doc.splitTextToSize(p.swot.f||"-", 85), 12, y+10);
        
        // O
        doc.setFillColor(255, 205, 210); doc.rect(10+w, y, w, h, 'F');
        doc.setFont("helvetica", "bold"); doc.text("OPORTUNIDADES", 12+w, y+5); doc.setFont("helvetica", "normal");
        doc.text(doc.splitTextToSize(p.swot.o||"-", 85), 12+w, y+10);
        
        y += h; 
        
        // Fr
        doc.setFillColor(200, 230, 201); doc.rect(10, y, w, h, 'F');
        doc.setFont("helvetica", "bold"); doc.text("FRAQUEZAS", 12, y+5); doc.setFont("helvetica", "normal");
        doc.text(doc.splitTextToSize(p.swot.fr||"-", 85), 12, y+10);
        
        // A
        doc.setFillColor(187, 222, 251); doc.rect(10+w, y, w, h, 'F');
        doc.setFont("helvetica", "bold"); doc.text("AMEAÇAS", 12+w, y+5); doc.setFont("helvetica", "normal");
        doc.text(doc.splitTextToSize(p.swot.a||"-", 85), 12+w, y+10);

        y += h + 10;
    }

    // ISHIKAWA (Table format in PDF)
    if(p.ishikawa){
        if(y > 220) { doc.addPage(); y=20; }
        doc.setFont("helvetica", "bold"); doc.text("Diagrama de Ishikawa (6M)", 10, y); y+=6;
        
        // Problema Principal
        doc.setFontSize(9);
        doc.text(`PROBLEMA / EFEITO: ${p.ishikawa.problema || "Não definido"}`, 10, y); y+=6;

        const ishiData = [
            ["Máquina", p.ishikawa.maquina || "-"],
            ["Método", p.ishikawa.metodo || "-"],
            ["Material", p.ishikawa.material || "-"],
            ["Mão de Obra", p.ishikawa.maoobra || "-"],
            ["Meio Ambiente", p.ishikawa.meioamb || "-"],
            ["Medida", p.ishikawa.medida || "-"]
        ];
        doc.autoTable({
            startY: y, head: [['Categoria','Causas']], body: ishiData,
            theme: 'grid', styles: { fontSize: 8 }
        });
        y = doc.lastAutoTable.finalY + 10;
    }

    // Resultados
    if(y > 250) { doc.addPage(); y = 20; }
    doc.setFont("helvetica", "bold"); doc.setFontSize(10);
    doc.text("Ranking de Fornecedores:", 10, y); y+=6;
    
    const resData = p.resultados.map((r, i) => [
        `#${i+1}`, r.nome, r.score.toFixed(2)
    ]);
    
    doc.autoTable({
        startY: y,
        head: [['Rank', 'Fornecedor', 'Score Final']],
        body: resData,
        theme: 'striped'
    });

    // Observações
    y = doc.lastAutoTable.finalY + 10;
    if(p.comentarios.length){
        doc.text("Histórico / Comentários:", 10, y); y+=6;
        doc.setFont("helvetica", "normal"); doc.setFontSize(8);
        p.comentarios.forEach(c=>{
            doc.text(c, 10, y); y+=5;
        });
    }

    doc.save(`Projeto_${p.nome.replace(/\s+/g,'_')}.pdf`);
}

/* ===================== FORNECEDORES ETC ===================== */
function renderFornecedores(clear){
  const sel = document.getElementById('filtroAreaNotas');
  if(sel.options.length<=1){
    AREAS.forEach(a=>{ const o=document.createElement('option');o.value=a.id;o.textContent=a.nome;sel.appendChild(o); });
  }
  if(clear) sel.value="";
  const areaNotas = sel.value || "";
  const div = document.getElementById('fornList');
  let head = `<tr><th>ID</th><th>Fornecedor</th><th>Áreas</th><th>Notas Globais</th>`;
  if(areaNotas) head += `<th>Notas — ${AREAS.find(a=>a.id===areaNotas)?.nome||areaNotas}</th>`;
  head += `<th>Ações</th></tr>`;

  let body = "";
  suppliers.forEach(f=>{
    const areas = f.areas.map(a=>AREAS.find(x=>x.id===a)?.nome||a).join(", ");
    const globais = Object.entries(f.notas?.global||{}).map(([k,v])=>{
      const n = indicesList.find(i=>i.id===k)?.nome||k; return `${n}: ${v}`;
    }).join("; ");

    let colArea = "";
    if(areaNotas){
      const notasA = f.notas?.porArea?.[areaNotas]||{};
      colArea = Object.entries(notasA).map(([k,v])=>{
        const n = indicesList.find(i=>i.id===k)?.nome||k; return `${n}: ${v}`;
      }).join("; ");
    }
    body += `<tr>
      <td>${f.id}</td><td>${f.nome}</td><td>${areas}</td><td>${globais||"—"}</td>
      ${areaNotas?`<td>${colArea||"—"}</td>`:""}
      <td><button class="btn secondary" onclick="editarFornecedor('${f.id}')">Editar</button> <button class="btn danger" onclick="excluirFornecedor('${f.id}')">Excluir</button></td>
    </tr>`;
  });
  div.innerHTML = `<table><thead>${head}</thead><tbody>${body}</tbody></table>`;
}

// Manutenção Fornecedores
let editingId = null;
function renderCadastro(){
  // 5. AJUSTE DE LAYOUT PARA CHECKBOXES
  document.getElementById('c_areas').innerHTML = AREAS.map(a=>`
    <div class="col-3">
        <label class="checkbox-label small">
            <input type="checkbox" value="${a.id}" onchange="renderNotasPorArea()"> ${a.nome}
        </label>
    </div>
  `).join("");

  document.getElementById('c_notasGlobais').innerHTML = indicesList.filter(i=>i.scope==="global").map(i=>`<label class="small">${i.id} — ${i.nome} <input type="number" min="0" max="10" step="0.1" data-id="${i.id}"></label>`).join("");
  renderNotasPorArea();
}

function renderNotasPorArea(){
  const marcadas = [...document.querySelectorAll('#c_areas input:checked')].map(i=>i.value);
  const idxArea = indicesList.filter(i=>i.scope==="area");
  const wrap = document.getElementById('c_notasPorArea');
  
  if(!marcadas.length){ wrap.innerHTML = `<p class="muted">Selecione áreas acima.</p>`; return; }
  
  // Layout similar a global (Grid)
  wrap.innerHTML = marcadas.map(a=>{
    const nome = AREAS.find(x=>x.id===a)?.nome||a;
    const ins = idxArea.map(i=>`
        <div class="col-3" style="margin-bottom:8px">
            <label class="small">${i.id} — ${i.nome}</label>
            <input type="number" min="0" max="10" step="0.1" data-id="${i.id}">
        </div>
    `).join("");
    
    return `<div class="card" style="background:var(--card2)">
        <div class="badge" style="margin-bottom:10px; font-weight:bold;">${nome}</div>
        <div class="row">${ins}</div>
    </div>`;
  }).join("");
}

function limparCadastro(){ editingId = null; document.getElementById('c_id').value=""; document.getElementById('c_nome').value=""; renderCadastro(); }

function salvarFornecedor(){
  const id = document.getElementById('c_id').value.trim();
  const nome = document.getElementById('c_nome').value.trim();
  if(!id || !nome){ alert("Preencha ID e Nome."); return; }
  const areas = [...document.querySelectorAll('#c_areas input:checked')].map(i=>i.value);
  if(!areas.length){ alert("Selecione áreas."); return; }
  
  const globais = {}; document.querySelectorAll('#c_notasGlobais input').forEach(inp=>{ const v=inp.value.trim(); if(v!=="") globais[inp.dataset.id]=clamp(v,0,10); });
  const porArea = {}; 
  
  // Agora buscamos por badge
  document.querySelectorAll('#c_notasPorArea .card').forEach(card=>{
    const anome = card.querySelector('.badge').textContent; 
    const aid = AREAS.find(a=>a.nome===anome)?.id;
    if(aid){ 
        porArea[aid]={}; 
        card.querySelectorAll('input').forEach(i=>{ 
            const v=i.value.trim(); 
            if(v!=="") porArea[aid][i.dataset.id]=clamp(v,0,10); 
        }); 
    }
  });
  
  const obj = { id, nome, areas, notas:{ global:globais, porArea } };
  if(editingId){ const ix=suppliers.findIndex(f=>f.id===editingId); if(ix>=0) suppliers[ix]=obj; editingId=null; }
  else{ if(suppliers.some(f=>f.id===id)){ alert("ID duplicado"); return; } suppliers.push(obj); }
  saveData(); alert("Salvo"); renderFornecedores();
}

function editarFornecedor(id){
  const f = suppliers.find(x=>x.id===id); if(!f) return;
  editingId=id; document.querySelector(".tab-btn[data-tab='cadastro']").click();
  document.getElementById('c_id').value=f.id; document.getElementById('c_nome').value=f.nome;
  renderCadastro();
  f.areas.forEach(a=>{ const el=[...document.querySelectorAll('#c_areas input')].find(i=>i.value===a); if(el) el.checked=true; });
  renderNotasPorArea();
  // preencher
  Object.entries(f.notas?.global||{}).forEach(([k,v])=>{ const el=document.querySelector(`#c_notasGlobais input[data-id='${k}']`); if(el) el.value=v; });
  Object.entries(f.notas?.porArea||{}).forEach(([aid,map])=>{ Object.entries(map).forEach(([k,v])=>{
     const areaCard = [...document.querySelectorAll('#c_notasPorArea .card')].find(c=>c.querySelector('.badge').textContent === (AREAS.find(a=>a.id===aid)?.nome));
     if(areaCard){ const el=areaCard.querySelector(`input[data-id='${k}']`); if(el) el.value=v; }
  });});
}
function excluirFornecedor(id){ if(confirm("Excluir?")){ suppliers=suppliers.filter(f=>f.id!==id); saveData(); renderFornecedores(); } }

/* ===================== INIT ===================== */
function initUI(){
  loadState();
  renderIndicesTableForProject();
  addAreaRow();
  updateProjectSelects();
  renderDbFilters();
  renderDashboard();
}

window.onload = loadState;
</script>
</body>
</html>
